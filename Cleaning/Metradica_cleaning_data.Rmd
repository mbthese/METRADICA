---
title: "Cleaning"
author: "Marion Boisseaux"
date: "2022-10-15"
output: html_document
---

# R environement for this code


*R version used 4.2.1*
*Packages are managed by an renv.lock for this project.*

##librairies
```{r eval=FALSE, include=FALSE}
library(googlesheets4)
gs4_auth(scopes = "https://www.googleapis.com/auth/spreadsheets.readonly" )
library(dplyr)
library(tidyr)
library(tidyverse)
library(readr)
```


# Introduction

Data cleaning of Metradica files from the four campaigns :

1- Paracou
2- Bafog
3- Kaw
4- Paracou FTH

# I - Paracou first campaign

**Paracou **: 9 of these permanent forest plots were subjected to 3 different forest exploitation treatments. Out of 9, 3 plots served as control plots. In 1992, 3 additional biodiversity / control plots of 6.25 ha in size and one 25 ha plot were established. Within these plots all trees with a diameter at breast height (DBH) above 10 cm were mapped. Species richness at Paracou ranges between 150 and 200 species per hectare. Since the establishment of the permanent forest plots, tree inventories take place at Paracou, recording tree status (alive or dead) and the DBH to the nearest 0.5 cm. Samplings were done in plots 6, 11, 13, 14, 15, and 16 from the 23/10/2020-7/12/2020 and from 13/09/2021- 17/09/2021. 244 trees sampled but 240 individuals with values. Lost 4 individuals (bota error usually).

## gmin

Using a combination of gmin function developped by D. Krebber and rectifying some individuals manually.

Minimum point chosen : 3
Minimum time lapse : 1.4 hours

Leaf area including petiole was calculated using imageJ.

After calculations with the gmin R project from the raw data, last steps are:

```{r}
Gmin_Paracou <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/traits/input/Gmin/input/Metradica/Paracou/output/Metradica_Campaing_2020_Gmin_Clean_OUT.csv", 
    col_types = cols(Code = col_integer()))

```

### checking errors for gmin

 
 -Individual 96: NON, 3.257 manual.
 -Individual 157 : NON 3.07 calculated manually (But Daniela 3.33)


```{r}

Gmin_Paracou$gmin.slope[Gmin_Paracou$Code == 157] <- 3.07 #rapid weight loss info but manual calculation
Gmin_Paracou$gmin.slope[Gmin_Paracou$Code == 96] <- 3.257 #adj part of curve info manual 



Gmin_Paracou$Code[which(Gmin_Paracou$gmin.slope >10)]
#[1] 212 235  26

Gmin_Paracou$gmin.slope[which(Gmin_Paracou$gmin.slope >10)]
#[1] 10.06892 12.60245 16.01937

#Yes, these were re-checked. 

```


```{r}
#save gmin file

write.csv(Gmin_Paracou, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/gmin.csv", row.names = FALSE)
```


## tlp

We assessed the leaf turgor loss point, $\pi_{tlp}$ in MPa, from a previously established relationship with the osmotic potential at full hydration, $\pi_{osm}$ in MPa. $\pi_{osm}$ is linked to the equilibrium solute concentration value $C_0$ (in mmol.kg^{-1}) directly measured with a vapor pressure osmometer (Vapro 5600, Wescor, Logan, UT). This is referred as the *osmometer method* (Bartlett et al. 2012a; Maréchaux et al. 2016).

### Uploading Ptlp data
 
Uploading Ptlp data from vapro excel files for all the 16 field days of METRADICA- Paracou 2020.
```{r setup, include=FALSE}
#####DO NOT MODIFY THIS CODE
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)
library(ggplot2)
library(forcats)
library(questionr)
#####DO NOT MODIFY THIS CODE - This will import the raw data

## Chargement des donnees Ptlp--------------------

#for i (1:10) trouver fonction de concatenation fichiers
#read_excel(concaténer "fichier"fonction concatenation pour le i"suite du fichier")


Jour_1_5 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_1_5_Ptlp_31_11_2020.xlsx", 
                                       sheet = "LAB_PiTlp", col_types = c("skip", 
                                                                          "skip", "skip", "numeric", "numeric", 
                                                                          "numeric", "numeric", "text", "skip", 
                                                                          "text", "text", "text", "skip", "skip", 
                                                                          "skip", "numeric", "skip", "skip", 
                                                                         "skip", "numeric", "numeric", "text"))

Jour_6 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_6_Ptlp_4_11_2020.xlsx", 
                                    col_types = c("skip", "skip", "skip", 
                                                  "numeric", "numeric", "numeric", 
                                                  "numeric", "text", "skip", "text", 
                                                  "text", "text", "skip", "skip", "skip", 
                                                  "numeric", "skip", "skip", "skip", 
                                                  "numeric", "numeric", "text"))


Jour_7 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_7_Ptlp_05_11_2020-1.xlsx", 
                     col_types = c("skip", "skip", "skip", 
                                   "numeric", "numeric", "numeric", 
                                   "numeric", "text", "skip", "text", 
                                   "text", "text", "skip", "skip", "skip", 
                                   "numeric", "skip", "skip", "skip", 
                                   "numeric", "numeric", "text"))

Jour_8 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_8_Ptlp_06_11_2020.xlsx", 
                     col_types = c("skip", "skip", "skip", 
                                   "numeric", "numeric", "numeric", 
                                   "numeric", "text", "skip", "text", 
                                   "text", "text", "skip", "skip", "skip", 
                                   "numeric", "skip", "skip", "skip", 
                                   "numeric", "numeric", "text"))

Jour_9 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_9_Ptlp_07_11_2020.xlsx", 
                     col_types = c("skip", "skip", "skip", 
                                   "numeric", "numeric", "numeric", 
                                   "numeric", "text", "skip", "text", 
                                   "text", "text", "skip", "skip", "skip", 
                                   "numeric", "skip", "skip", "skip", 
                                   "numeric", "numeric", "text"))

Jour_10 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_10_Ptlp_10_11_2020.xlsx", 
                     col_types = c("skip", "skip", "skip", 
                                   "numeric", "numeric", "numeric", 
                                   "numeric", "text", "skip", "text", 
                                   "text", "text", "skip", "skip", "skip", 
                                   "numeric", "skip", "skip", "skip", 
                                   "numeric", "numeric", "text"))
Jour_11 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_11_Ptlp_12_11_2020.xlsx", col_types = c("skip", "skip", "skip", 
                                                                                                                    "numeric", "numeric", "numeric", 
                                                                                                                    "numeric", "text", "skip", "text", 
                                                                                                                    "text", "text", "skip", "skip", "skip", 
                                                                                                                    "numeric", "skip", "skip", "skip", 
                                                                                                                    "numeric", "numeric", "text"))


Jour_12_1 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_12_Ptlp_14_11_2020_1.xlsx", 
                     col_types = c("skip", "skip", "skip", 
                                   "numeric", "numeric", "numeric", 
                                   "numeric", "text", "skip", "text", 
                                   "text", "text", "skip", "skip", "skip", 
                                   "numeric", "skip", "skip", "skip", 
                                   "numeric", "numeric", "text"))


Jour_12_2 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_12_Ptlp_14_11_2020-2.xlsx", 
                        col_types = c("skip", "skip", "skip", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "text", "skip", "text", 
                                      "text", "text", "skip", "skip", "skip", 
                                      "numeric", "skip", "skip", "skip", 
                                      "numeric", "numeric", "text"))


Jour_13 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_13_Ptlp_17_11_2020.xlsx", 
                        col_types = c("skip", "skip", "skip", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "text", "skip", "text", 
                                      "text", "text", "skip", "skip", "skip", 
                                      "numeric", "skip", "skip", "skip", 
                                      "numeric", "numeric", "text"))

Jour_14 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_14_Ptlp_20_11_2020.xlsx", 
                      col_types = c("skip", "skip", "skip", 
                                    "numeric", "numeric", "numeric", 
                                    "numeric", "text", "skip", "text", 
                                    "text", "text", "skip", "skip", "skip", 
                                    "numeric", "skip", "skip", "skip", 
                                    "numeric", "numeric", "text"))

Jour_15 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_15_Ptlp_1_12_2020.xlsx", 
                      col_types = c("skip", "skip", "skip", 
                                    "numeric", "numeric", "numeric", 
                                    "numeric", "text", "skip", "text", 
                                    "text", "text", "skip", "skip", "skip", 
                                    "numeric", "skip", "skip", "skip", 
                                    "numeric", "numeric", "text"))

Jour_16 <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_Ptlp/Excel_Ptlp/Jour_16_Ptlp_08_12_2020.xlsx", 
                      col_types = c("skip", "skip", "skip", 
                                    "numeric", "numeric", "numeric", 
                                    "numeric", "text", "skip", "text", 
                                    "text", "text", "skip", "skip", "skip", 
                                    "numeric", "skip", "skip", "skip", 
                                    "numeric", "numeric", "text"))




# Uniting excel Ptlp files  

Ptlp_tidy <- bind_rows(Jour_1_5,Jour_6,Jour_7,Jour_8,Jour_8,Jour_9,Jour_10,Jour_11,Jour_12_1,Jour_12_2,Jour_13,Jour_14,Jour_15,Jour_16)


```


### Tidying Ptlp data

### Renaming variables

```{r}
Ptlp_tidy <- rename(Ptlp_tidy, 'NrRunLeaf' = 'nrRun...4', 'NrRunVapro' =  'nrRun...10' )

Ptlp_tidy <- rename(Ptlp_tidy,'C_0' = Posm) # le vapro mesure une concentration
```

### Arranging the tibble
```{r}
Ptlp_tidy <- Ptlp_tidy %>% arrange(`Code RWC`) #sort ascending

View(Ptlp_tidy)
```

### Identify duplicates

```{r}

#1 (seul vrai doublon avec deux bonnes valeurs), 55, 98, 107, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 160 (nvarpo==10 donc on garde le 160bis)
Doublons <-  filter(Ptlp_tidy, duplicated(`Code RWC`))

# enlever les vrais doublons
Ptlp_tidy <-  unique(Ptlp_tidy)


#Doublons restants: 1;55;98;107;160 
Doublons_2 <-  filter(Ptlp_tidy, duplicated(`Code RWC`))
View(Doublons_2)

Ptlp_tidy <- Ptlp_tidy[-2,] #choix pour le RWC Code 1 : stabilisation + longue.
Ptlp_tidy <- Ptlp_tidy[-56,] #RWC Code 55, les deux étaient 'abandon'
Ptlp_tidy <- Ptlp_tidy[-99,] #RWC Code 98 vrai doublon mais non detecté avant car NA en spName
Ptlp_tidy <- Ptlp_tidy[-104,] #RWC code 104 not the good species, not Cas. jav from RWC raw data comment 
Ptlp_tidy <- Ptlp_tidy[-107,] #RWC Code 107 vrai doublon mais non detecté avant car NA en spName
Ptlp_tidy <- Ptlp_tidy[-160,] #On garde le 160bis

```

#### recoding certain values 
##### species name mistakes
Some species names had mistakes like *Symp.glo* instead of *Sym.glo*.
```{r}
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Car sur'='Car.sur')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Car.pro'='Car.sur')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Chr pri'='Chr.pri')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Con gui'='Con.gui')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Dir.cor'='Dic.gui')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Epe fal'='Epe.fal')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Esc cor'='Esc.cor')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Hym het'='Hym.het')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Iry.has'='Iry.hos')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Jac.cap'='Jac.cop')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Jac cap'='Jac.cop')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Lae pro'='Lae.pro')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Pro Opa'='Pro.opa')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Symp.glo'='Sym.glo')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Sym glo'='Sym.glo')
Ptlp_tidy$spName <- recode(Ptlp_tidy$spName, 'Vir mic'='Vir.mic')
```



##### handling missing data
Three individuals are missing from the sampling: RWC Code 58,59,25.
Some individuals have no values for the $C_0$ because the osmometer could not stabilize and get a value. 

```{r echo=FALSE}
kable(colSums(is.na(Ptlp_tidy)))
```


#### from $C_0$ to $\pi_{osm}$ to $\pi_{tlp}$

The equilibrium solute concentration value $C_0$ (in mmol.kg^{-1}) was recorded from the osmometer when the difference between two consecutive measurements fell below 5 mmol.kg^{-1}. This value was converted to $\pi_{osm}$ values using the van't Hoff equation:  
 
 $\pi_{osm}$ = $(-2.5/1000)$x$C_0$
 
  where the numerator of the first term represents RxT = 2.5 L.MPa.mol^{-1}^ at 25°C, with R the ideal gas constant and T the temperature in Kelvin degrees.
  
The value $\pi_{osm}$ was then converted to $\pi_{tlp}$ using the following equation:  
 
$\pi_{tlp}$= ( 0.799x $\pi_{osm}$ ) -0.665
 
```{r}
# Calculate new numeric variables with math formulas

Ptlp_tidy<- mutate(Ptlp_tidy, P_osmo=(-2.5/1000)*C_0)
Ptlp_tidy <- mutate(Ptlp_tidy, P_tlp=(0.799*P_osmo)-0.665) #Maréchaux formula adapted from bartlett but for tropical species.

view(Ptlp_tidy)

```

#### checking for errors

- Code 142 : nothing to report
- Code 238 : young + herbivory
- Code 177 : nothing to report, but jacaranda is known to have blackened leaves.
- Code 39 : nothing to report
- Code 221 : nothing to report
- Code 194 : nothing to report
- Code 126 : herbivory 


#### printing the tidy data 
```{r echo=TRUE, message=TRUE, warning=TRUE}

Ptlp_tidy
write_csv(Ptlp_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/tlp.csv")
```


## majvla

The leaf is a critical component in the plant water transport system, accounting for 30% or more of whole-plant hydraulic resistance (Sack and Holbrook, 2006). Leaf venation architecture has numerous common functions across plant species—see Sack & Scoffoni, 2013 for review. Briefly, the leaf venation serves for mechanical support (Niklas, 1999), sugar and hormone transport in the phloem (Kehr & Buhtz, 2008), and, via the xylem, the replacement of water lost to transpiration when the stomata open for photosynthesis (Sack & Holbrook, 2006). However, venation architecture is highly diverse across species (Uhl & Mosbrugger, 1999; Roth-Nebelsick et al., 2001; Sack & Frole, 2006; Ellis et al., 2009; Brodribb et al., 2010). In dicotyledons, the leaf venation system typically consists of three orders of major veins and up to five higher orders of minor veins embedded in the mesophyll, with the vein orders arranged in a hierarchy; lower order veins are larger in diameter, with greater xylem conduit numbers and sizes, whereas higher order veins have greater length per leaf area (VLA; Sack & Holbrook, 2006; McKown et al., 2010). Total leaf VLA has been shown to correlate with maximum hydraulic conductance and photosynthetic rate per area across species (Sack & Frole, 2006; Brodribb et al., 2007) and tends to be higher for species growing in high light. Major VLA has been found to play a role in determining the damage tolerance of the vein system, and in leaf drought tolerance (Sack et al., 2008; Scoffoni et al., 2011).


Leaf area (LA, mm2 ) 
Major vein density (Major VLA, mm/mm2) : vein length per unit area 
Sum of vein densities for 1°, 2° and 3° veins (mm mm-2)
Double sided lamp flatbed scanner
ImageJ

Measurements from Scoffoni's Lab. These measures were calculated by a student group project from January - March 2022.

```{r Vein Paracou, eval=FALSE, include=FALSE}
library(readxl)
library(forcats)
library(dplyr)
library(tidyverse)

Veindata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Scoffoni/results/Scoffoni_Paracoudata.csv") %>% select(Code, spName, midribVLA_S1,	SecondaryVLA_S1,	TertiaryVLA_S1,	MajVLA_S1,	midribVLA_S2,	SecondaryVLA_S2,	TertiaryVLA_S2,	MajVLA_S2) 


#averaging the two students' measurements
Veindata_tidy <- Veindata %>% mutate(MajVLA = (MajVLA_S1 + MajVLA_S2)/2, midribVLA = (midribVLA_S1+ midribVLA_S2)/2, SecondaryVLA = (SecondaryVLA_S1 + SecondaryVLA_S2) / 2, 	TertiaryVLA = (	TertiaryVLA_S1+ 	TertiaryVLA_S2)/2) %>% select(Code, spName, midribVLA , SecondaryVLA, TertiaryVLA ,  MajVLA) %>% na.omit()


write_csv(Veindata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/majvla.csv")
```


## chemistry

```{r Chemistry Paracou}
library(readr)
#chemistry from all sites
Chemistry <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Grinding/Chemistry.csv") 

#only paracou
Chemistry_Paracou <- Chemistry %>% filter(Code < 245)

write_csv(Chemistry_Paracou, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/chemistry.csv")
```


## lswc

The relative water content (RWC; %) was calculated as (fresh weight - dry weight) / (turgid weight - dry weight) * 100. 

#### setting up the R environment
```{r setup, include=FALSE}
#####DO NOT MODIFY THIS CODE
knitr::opts_chunk$set(echo = TRUE)

## packages---------------------------
#install.packages("tidyverse")
#install.packages("readxl")
#install.packages("devtools")

## libraries------------------------
library(tidyverse)
library(knitr)
library(readxl)
library(ggplot2)
library(forcats)
library(questionr)
```

#### uploading RWC data

Uploading RWC data from excel file for all the 16 field days of METRADICA- Paracou 2020.


```{r setup, include=FALSE}
RWC_Paracou <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_RWC/METRADICA_RWC.xlsx")

```

#### tidy

```{r setup, include=FALSE}
d<- select(RWC_Paracou, -DateMeasBag, -NameBagWeight, -DateField, -NameFW, -DateFW, -TimeFW, -idSample,
           -NameSW, -DateSW, -timeSW, -NameDW, -DateDW, -timeDW, -CommentField)

d<- rename(d, Code = BagNr., `Fresh_Weight(g)` = `FW(g)`,
           `Saturated_Weight(g)` = `SW(g)`,
           `Dry_Weight(g)` = `DW(g)`,
           `Bag_Weight(g)` = `WeightWhirlPak(g)`,
           `Delta_Weight_SW-FW(g)` = `DeltaWeightSW-FW`)


# <- d %>% separate(spName, c("Genus", "Species"))

#d$Genus <- str_replace(d$Genus, "Boc", "Bocoa") 
#d$Genus <- str_replace(d$Genus, "Car", "Carapa")
#d$Genus <- str_replace(d$Genus, "Cas", "Casearia")
#d$Genus <- str_replace(d$Genus, "Chr", "Chrysophyllum")
#d$Genus <- str_replace(d$Genus, "Con", "Conceveiba")
#d$Genus <- str_replace(d$Genus, "Dic", "Dicorynia")
#d$Genus <- str_replace(d$Genus, "Epe", "Eperua")
#d$Genus <- str_replace(d$Genus, "Esc", "Eschweilera")
#d$Genus <- str_replace(d$Genus, "Gus", "Gustavia")
#d$Genus <- str_replace(d$Genus, "Hym", "Hymenopus")
#d$Genus <- str_replace(d$Genus, "Iry", "Iryanthera")
#d$Genus <- str_replace(d$Genus, "Jac", "Jacaranda")
#d$Genus <- str_replace(d$Genus, "Lae", "Laetia")
#d$Genus <- str_replace(d$Genus, "Lic", "Licania")
#d$Genus <- str_replace(d$Genus, "Por", "Poraqueiba")
#d$Genus <- str_replace(d$Genus, "Pro", "Protium")
#d$Genus <- str_replace(d$Genus, "Pte", "Pterocarpus")
#d$Genus <- str_replace(d$Genus, "Sym", "Symphonia")
#d$Genus <- str_replace(d$Genus, "Tac", "Tachigali")
#d$Genus <- str_replace(d$Genus, "Vir", "Virola")
#d$Genus <- str_replace(d$Genus, "Vou", "Vouacapoua")




d <- d %>% relocate(starts_with('Bag_Weight(g)'), `FW+BW(g)` , `Balance` , .after = `Dry_Weight(g)`)


## R Bags Table ----------------------------
#Delete Weights of R Bags used for the big leaves from the main dataset 

R_Bag_Weight<- d %>% filter(str_detect(d$Code, pattern = "R")) #extraire une autre table pour les R-bags à partir de Code commençant par "R" 

R_Bag_Weight<- rename(R_Bag_Weight, R_Bag_Code = Code, Comment = CommentWeightBag)

R_Bag_Weight <- R_Bag_Weight %>% relocate(starts_with('Bag_Weight(g)') , `Balance` , .after = `R_Bag_Code`)

R_Bag_Weight<- select(R_Bag_Weight, -`Fresh_Weight(g)`, -`Saturated_Weight(g)`, - `Delta_Weight_SW-FW(g)`, -`Dry_Weight(g)`, -CommentLab,
                                     -`FW+BW(g)`)


R_Bag_Weight<- distinct(R_Bag_Weight, R_Bag_Weight$R_Bag_Code, .keep_all = TRUE) # enleve les doublons



R_Bag_Weight<- mutate(R_Bag_Weight, RCode = R_Bag_Code) #creer une colonne pour ordonner les Rbags basée sur la colonne des R_Bag_Code. Mais penible pour ordonner en ayant la lettre R. Sinon, le tri s'effectue R1 / R10 / R11 / R2 etc.


R_Bag_Weight$RCode<- str_replace(R_Bag_Weight$RCode, "R", "") 


R_Bag_Weight$RCode <- as.numeric(R_Bag_Weight$RCode)

R_Bag_Weight <- arrange(R_Bag_Weight,  R_Bag_Weight$RCode) # pour ordonner par numeros croissants

R_Bag_Weight<- select(R_Bag_Weight, -`R_Bag_Weight$R_Bag_Code`) # en enlevant les doublons, cette colonne s'est rajoutée toute seule, elle sert à rien à présent



## Continue tidy data RWC----------------

d<- d[-c(60:69, 91:100, 165, 230, 257),]

d$Code <- str_replace(d$Code, "M", "")

d$`Saturated_Weight(g)`<- as.numeric(d$`Saturated_Weight(g)`)
d$`FW+BW(g)` <- as.numeric(d$`FW+BW(g)`)
d$`Delta_Weight_SW-FW(g)` <- as.numeric(d$`Delta_Weight_SW-FW(g)`)

lswc <- d %>% select(Code, `Fresh_Weight(g)`, `Saturated_Weight(g)`, `Dry_Weight(g)`) %>% rename(FW = `Fresh_Weight(g)`, SW = `Saturated_Weight(g)`, DW = `Dry_Weight(g)`) %>% mutate(LSWC = (SW-DW)/DW)




```


#### checking lswc data with outliers

-Code 137 : FW > SW
-Code 68 : *eliminate indvidual because in raw data there is a comment : "valeur prise trop tard, pb de synchronisation"*
-Code 40: FW > SW
-Code 153 : FW > SW
-Code 148 : OK
-Code 39 : OK
-Code 182 : OK
-Code 130 : DW > SW : problem de mesure: take it out

```{r}
lswc$LSWC[lswc$Code == 68] <- NA
lswc$LSWC[lswc$Code == 130] <- NA
```




#### saving lswc data
```{r}

write_csv(lswc, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/lswc.csv")
```


## stomata

From the labelStoma app developped by Angela Casado. LabelStoma is a graphical image tool for automatically detecting stomata in images. All info are referenced in her Github : https://github.com/ancasag/labelStoma

After counting all stomata from paracou campaign and FTH, she adapted the weights of labelStoma for me to recognize the same species of the bafog and kaw campaign. 

Once all stomata are counted, labelStoma generates excel files where it tells how many stomata are in each image. 

I am using *labelStoma* for the annotation.
After all annotated images, I will generate the excel to calculte the stomatal density using *labelStomaMarion*, as it has the scale option I want.

All Paracou images sizes are: *1392* x *1040* in BMP format: 
-X20 Scale conversion: 0.5 mm = 2145 pixel/mm; 0.65 mm *0.48 mm = 0.312 mm^2 image sizes
-X40 Scale conversion: 0.2 mm = 4250 pixel/mm; 0.33 mm * 0.24 mm = 0.0792 mm^2 image sizes


```{r Stomata Paracou}


stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_stomates/MetradicaParacou - stomata.csv") 

stomata_tidy <- stomata %>% select(Code, SpCode, Countx10, Countx20, Countx40, ImageSizex20_mm2, ImageSizex40_mm2, StomatalDensity_Stomate_mm2, Comment_Stomata)

stomata_tidy <- stomata_tidy %>% filter(Code < 245)

stomata_tidy <- stomata_tidy %>% mutate(SD = ifelse(!is.na(Countx20), Countx20 / ImageSizex20_mm2 , Countx40 / ImageSizex40_mm2))

```

```{r outlier stomata paracou checks}
#looking at outliers
#from Machado et al 2021 (130 - 1708 mm^-2 for the Stomatal Density range)

stomata_impossible<- stomata_tidy %>% filter(SD < 90 ) # the lowest SD are also the ones that were really hard to calculate. I went back to the raw files and clearly impossible to see or calculate correctly for those ones.

stomata_tidy <- stomata_tidy %>% filter(SD > 90 ) 
#plot to see if anymore outliers stand out
###plot all

stomata_all_plot <- ggplot(stomata_tidy) +
  aes(
    x = SpCode,
    y = SD,
    fill = SpCode
  ) +
  geom_boxplot() +
  scale_fill_hue(direction = 1) +
  theme_minimal()  +
  ggtitle("Stomata_Paracou_all")

ggsave(stomata_all_plot, file = "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Check_stomata/All_Paracou_Stomata.jpg", width = 35, height = 20, units = "cm")

#per species loop
options(ggrepel.max.overlaps = Inf)
SpCode <- unique(stomata_tidy$SpCode)
for (i in SpCode) {

Stomata_Plotting <- stomata_tidy %>% filter(SpCode == i)
############# WITHOUT LABELS
PlotFam <- ggplot(data = Stomata_Plotting, aes(x = SpCode, y=SD)) + 
           geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
    
 scale_y_continuous(breaks = seq(from = 0.0, to = 900, by = 20), limits = c(0, 900))+
  
   geom_point(aes(color = SpCode), size = 2.5)  +

  ggtitle(paste0(i, ": Stomata"))
print(PlotFam)
#ggsave(PlotFam, file = paste("Outlier_analysis/images/Plots_Outliers_per_Family/gmin/", i,"gmin.jpg", sep = ""), width = 35, height = 20, units = "cm")
 
################# WITH LABELS 

PlotFam_label <- ggplot(data = Stomata_Plotting, aes(x = SpCode, y=SD)) + 
  geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
  scale_y_continuous(breaks = seq(from = 0.0, to = 900, by = 20), limits = c(0, 900))+
  
  
  geom_point(aes(color = SpCode), size = 2.5)   +
  
  
ggnewscale::new_scale_fill() + 
  
 ggrepel::geom_label_repel(aes(label = Code, fill = as.factor(Comment_Stomata)),  data = Stomata_Plotting,
                  
                   nudge_y       = 0 ,
                   nudge_x       = 0,
                 size          = 2,
                  box.padding   = 1,
                  point.padding = 0.5,
                  
                  segment.size  = 0.3,
                  segment.color = "black",
                  direction     = "both") +
#                             
  ggtitle(paste0(i, ": Stomata"))


#print(PlotFam)  
print(PlotFam_label)

ggsave(PlotFam_label, file = paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Check_stomata" , i, "_Stomata.jpg"), width = 35, height = 20, units = "cm")

} 

#outliers detection:
#a more complete check would be after join all sites, because some might seem outliers but let's see the rest as well
#no removal at theis stage

#M240 seems weird
#M62

```

```{r Final Paracou stomata}
stomata_tidy <- stomata_tidy %>% select(-StomatalDensity_Stomate_mm2)

write_csv(stomata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/stomata.csv")

```


## fvfm

Eliminate individual 147 

```{r}
fvfm <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_FvFm/FvFm_tidy_Paracou.csv") %>% rename(Code = BagNr., FVFM = Fv.Fm)

fvfm_tidy <- fvfm

fvfm_tidy$FVFM[fvfm_tidy$Code == 198] <- 0.815 #correct value read from the lab notebook.

#indv 147 has a very low value to consider robust measurements for the other traits on healthy leaves.  --> eliminate

fvfm_tidy$FVFM[fvfm_tidy$Code == 147] <- NA

write_csv(fvfm_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/fvfm.csv")
```


## joining traits - Paracou campaign

```{r Summary Paracou}
Gmin <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/gmin.csv") %>% 
  select(sample_id, gmin.slope) %>% rename(Code = sample_id, gmin = gmin.slope) 

Gmin$Code <- as.integer(Gmin$Code)

TLP <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/tlp.csv") %>%
  select(`Code.RWC`, P_tlp) %>% rename(Code =`Code.RWC`,TLP = P_tlp)


Paracou <- left_join(Gmin, TLP)

Vein <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/majvla.csv") %>% select(-spName)

Vein$Code <- as.numeric(Vein$Code) 

Paracou <- left_join(Paracou, Vein)

Chem <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/chemistry.csv")  %>% select(Code, Genus, Species, X.N, X.C, `P..g.kg.`, `Ca..g.kg.`, `Na..g.kg.`, `K..g.kg.`) %>% rename(N = X.N, C = X.C, P =`P..g.kg.`, Ca= `Ca..g.kg.`, Na= `Na..g.kg.`, K= `K..g.kg.`)

Paracou <- left_join(Paracou, Chem) 

LSWC <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/lswc.csv") %>% select(Code, FW, SW, DW , LSWC)


Paracou <- left_join(Paracou, LSWC) 

Stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/stomata.csv") %>% select(Code, SD, Comment_Stomata)

Paracou <- left_join(Paracou, Stomata) 

fvfm <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/fvfm.csv") %>% select(Code, FVFM)
#beware we eliminated individual 147 because leaves were not healthy

Paracou <- left_join(Paracou, fvfm) 

Paracou <- Paracou[!(Paracou$Code=="147"),]
```

### field information 

D. Krebber cleaned the IDTREE with an R function. Using those to match my individuals.
```{r}
IDTREE <- read_csv("Cleaning/Clean_Paracou/Metradica_Paracou_2020_Individual_based_Trait_Data_Version_DK - Metradica_Paracou_2020_Individual_based_Trait_Data_Version_DK.csv") %>% select(Code, idTree, spName_CorrBota)

Paracou_Indv <- left_join(Paracou, IDTREE) %>% relocate(idTree, .after = Code) %>% relocate( spName_CorrBota, .after = Species)


#checks on the bota names of individuals
library(stringr)
Paracou_Indv$Name <- str_c(Paracou_Indv$Genus, '_', Paracou_Indv$Species)
Paracou_Indv$Code[which(Paracou_Indv$Name != Paracou_Indv$spName_CorrBota)]
#yes most of it is ok, because its the jacaranda and protium but let's correct them


Paracou_Indv$Genus[Paracou_Indv$Code == 18] <- 'Chrysophyllum'
Paracou_Indv$Species[Paracou_Indv$Code == 18] <- 'prieurii'


Paracou_Indv <- Paracou_Indv %>% select(-Genus, -Species, -Name) %>% rename(Name = spName_CorrBota) %>% relocate(Name, .after = idTree)

Paracou_Indv <- Paracou_Indv %>% separate(Name, into = c("Genus", "Species"), sep = "_")


#find duplicates
Paracou_Indv$Code[duplicated(Paracou_Indv$Code)]

Paracou_Indv <- Paracou_Indv %>% distinct() #don't know why code 238 was there 3 times 

# adding dawkins, crown position, date field, forest, plot, subplot, filedNB, habitat, type

Field_info <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/MetradicaParacou - individuals_withIDTREE.csv") %>% select(-CodeFTH, -Genus, -Species)

Paracou <- left_join(Paracou_Indv, Field_info)

#Having IdTree problems 

Paracou$Code[which(is.na(Paracou$CrownPosition))]
#[1] 156  90 105
#156: idTree correct 144042 referred after looking at https://paracoudata.cirad.fr/
#90 : normal car valeur non renseigné du terrain
#105 : idTree correct 144423 refered after looking at the paracou data: https://paracoudata.cirad.fr/

Field_info$idTree[Field_info$Code == 156] <- 144042
Field_info$idTree[Field_info$Code == 105] <- 144423

Paracou <- left_join(Paracou_Indv, Field_info)

#last jacaranda copaia correct
Paracou$Species[Paracou$Genus == 'Jacaranda'] <- 'copaia subsp. copaia'

```

## final data for the first paracou campaign
```{r}
write_csv(Paracou, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Paracou.csv")
```



# II - Bafog

**Bafog**: 5 permanent plots monitored of the ONF institute. Samplings were done in plots 2, 3, 4, and 5 and off plots from the 1<sup>st</sup> to  16<sup>th</sup> of March 2021.  

# Cleaning individual information

```{r Individuals_Bafog, eval=FALSE, include=FALSE}
library(readxl)
library(tidyverse)
library(dplyr)
library(rio)

Bafog_individuals <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Bafog_individuals.xlsx", 
    sheet = "Bafog_individuals") %>% 
  select(-CrownPosition)

Bafog_individuals$Species[Bafog_individuals$Genus == 'Jacaranda'] <- 'copaia subsp. copaia'

Bafog_individuals <- Bafog_individuals %>%
  mutate(Name = paste0(Genus, " ", Species))


Bafog_individuals <- Bafog_individuals %>% 
  select(-Species_Name, -Site) %>%
  relocate(Genus, .after = FieldNbr) %>%
  relocate(Species, .after = Genus) %>%
  relocate(Name, .after = Species) %>%
  relocate(Habitat, .after = Name) %>%
  relocate(Forest, .after= DateField)

#get the habitat and type
Bafog_habitat <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/habitattype.csv") %>% select(-Name)

Bafog_fieldsheet <- left_join(Bafog_habitat,Bafog_individuals ,  by = c("Code", "Genus", "Species", "Habitat", "Forest", "TreeHeight", "TreeDawkins", "BranchHeight", "BranchDawkins"))

Bafog_fieldsheet <- Bafog_fieldsheet %>%
  relocate(DateField, .after= Code) %>%
  relocate(Forest, .after= DateField) %>%
  relocate( c("Plot", "Subplot", "FieldNbr"), .after= Forest ) %>%
  relocate(idTree, .after = Forest)

write.csv(Bafog_fieldsheet, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/Bafog_individuals.csv")

```


## lswc

Leaf-saturated water content (LSWC; g.g−1) was calculated as the mass of leaf water (SW – DW) divided by leaf dry mass (DW).

```{r eval=FALSE, include=FALSE}
library(readxl)
library(dplyr)
library(tidyverse)

RWC_raw <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/RWC/RWC_METRADICA_BAFOG_25_03_21.xlsx",  sheet = "RWC")

RWC <- RWC_raw %>% select(Unique_Code, FW, SW, DW, Comment_Lab) %>% rename(Code =Unique_Code) %>% mutate(C = SW - FW) %>% mutate(C2 = SW- DW)

#RWC$Code[which(RWC$C < 0 )] juste pour regarder quand SW- FW < 0 ce qui ne devrait pas arriver.

#RWC$Code[which(RWC$C2 < 0 )] #juste pour regarder quand SW- DW < 0 ce qui ne devrait pas arriver.


RWC <- RWC %>% select(Code, FW, SW, DW) %>% mutate(LSWC = (SW-DW)/DW) %>% select(-FW, -SW, -DW)

write_csv(RWC, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/lswc.csv")

```

## FvFm

```{r fvfm bafog, eval=FALSE, include=FALSE}
library(readxl)
FvFm <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/FvFm - cahier/Bafog_FvFm.xlsx")
FvFm <- FvFm %>% 
  select(-Comment_FvFm) %>% 
  mutate(FvFm= `Fv/Fm`/1000)

FvFm$Code[which(FvFm$FvFm < 0.6 )] # le Code 415 3 belles feuilles mais peut etre en lien avec le chablis récent, mesures refaites 3 fois, tjs meme valeurs.

#elimination de l'individu 415 car pas un fvfm qui nous renseigne sur un bon etat de sante de la feuille.

FvFm$FvFm[FvFm$Code == 415] <- NA

write_csv(FvFm, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/fvfm.csv")
```

## gmin

LA calculated with ImageJ (Marion Boisseaux) script and manual detour (Alice Bordes) for 8 species.

Check resolution of images.
```{r}
path <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/scan/0_Scan_bafog")
resolution <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/scan/0_Scan_bafog/",path),tags = "XResolution")
ResolutionProblems <- resolution %>% filter(XResolution!=1328)

```

All images 1328 ppp qui correspond à 1600 dpi. 
* Except 3 scans 1325 ppp. Code : 261, 264, 266. 
* Except 8 scans 1200 ppp. Code : 249, 276, 295, 317, 374, 383, 401, 410. These leaves were too big for the double sided scans, so we scaned with a lesser resolution (800 dpi) one side. 

Note: PPI describes the resolution in pixels of a digital image whereas DPI describes the amount of ink dots on a printed image. Though PPI largely refers to screen display, it also affects the print size of your design and thus the quality of the output.


```{r}
library(readxl)
library(dplyr)
LA_gmin <- read_excel("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/scan/Species_LeafAreaGmin_Alice.xlsx")

LA_gmin %>%
  mutate(Resolution_dpi = if_else(Resolution_ppp == 1328, 1600, 0))


LA_gmin <- LA_gmin %>%
  mutate(Resolution_dpi = 
           case_when(
    Resolution_ppp == 1328 ~ "1600", 
    Resolution_ppp == 1325 ~ "1600",
    Resolution_ppp == 1200 ~ "1200"))

LA_gmin$Resolution_dpi <- as.numeric(LA_gmin$Resolution_dpi)

LA_gmin <- LA_gmin %>%mutate(PixelArea = coalesce(TotalArea, ManualArea))

```

Calculate pixel² in cm²

Formula: PixelArea/(resolution_dpi^2)*(2.54^2)
```{r}
library(rio)
LA_gmin <- LA_gmin %>% 
  mutate(LA = 
  PixelArea/(Resolution_dpi^2)*(2.54^2) )

LA_gmin <- LA_gmin %>% relocate(Resolution_dpi, .after = Resolution_ppp)

write_csv(LA_gmin, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/LA_gmin.csv")
```

With Daniela's function, calculte gmin for all bafog individuals. 
```{r old script gmin, eval=FALSE, include=FALSE}

#old gmin script

gmin <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/Gmin_Marion/documents/data/output/Bafog/Gmin_withLA.csv")
gmin <- gmin %>% rename(LA= Leaf_area, gmin = gmin.slope_function) %>% select(Code, LA, gmin)

#check gmin

gmin$gmin[gmin$Code == 377] <- 8.7116
gmin$gmin[gmin$Code == 429] <- 12.28 *
gmin$gmin[gmin$Code == 416] <- 14.5253
gmin$gmin[gmin$Code == 374] <- 3.7775
gmin$gmin[gmin$Code == 317] <- 11.43 *
gmin$gmin[gmin$Code == 395] <- 9.73 *
gmin$gmin[gmin$Code == 376] <- 10.9998
gmin$gmin[gmin$Code == 430] <- NA #individu eliminé car cf comment raw gmin bafog
gmin$gmin[gmin$Code == 355] <- 10.8779
gmin$gmin[gmin$Code == 465] <- 9.95 *
gmin$gmin[gmin$Code == 396] <- 13.03
gmin$gmin[gmin$Code == 407] <- 10.75 
gmin$gmin[gmin$Code == 281] <- 6.72 *
gmin$gmin[gmin$Code == 421] <- 14.22 *
gmin$gmin[gmin$Code == 422] <- 9.6 *
gmin$gmin[gmin$Code == 392] <- 9.25 *
gmin$gmin[gmin$Code == 389] <- 8.16
gmin$gmin[gmin$Code == 404] <- 5.92
gmin$gmin[gmin$Code == 386] <- 6.45
gmin$gmin[gmin$Code == 375] <- 9.3353 *
gmin$gmin[gmin$Code == 436] <- 26.65
gmin$gmin[gmin$Code == 435] <- 11.83
gmin$gmin[gmin$Code == 339] <- 8.71 *
gmin$gmin[gmin$Code == 351] <- 7.30 *
gmin$gmin[gmin$Code == 366] <- 4.85
  
gmin$Code[which(gmin$gmin >10)]
 #[1] 256 269 271 289 306 317 325 355 369 376 396 407 416 421 429 435 436 450 466 #and these were checked

gmin$gmin[which(gmin$gmin <1)]
#none

```

```{r after data cleaning with daniela script}
gmin <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/traits/input/Gmin/input/Metradica/Bafog/output/Metradica_Bafog_Gmin_Clean_OUT.csv")

#info 430  NA car individu eliminé car cf comment raw gmin bafog and not good species detected also while doing majvla.
```


```{r}
write_csv(gmin, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/gmin.csv")
```


## tlp


```{r}
library(readr)
library(dplyr)
library(tidyverse)
library("purrr")

Ptlp <- list.files(path = "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/Ptlp/", pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read_delim, delim = ";", escape_double = FALSE, trim_ws = TRUE) %>%                              
  reduce(full_join)

Ptlp <- Ptlp %>% mutate(Posmo=(-2.5/1000)*C0) %>% mutate(Ptlp=(0.799*Posmo)-0.665) %>% rename(Code = Unique_Code)

Ptlp <- Ptlp %>% drop_na(Ptlp)

#Code 321 species is Tacmel, erreur de saisi. Eliminer le Code 321 *ou il y a ecrit espece jaccop. checker aussi avec le vapro file, c'etait enfait un 320 bis.

Ptlp <- Ptlp[-73,]

#mesure faites deux fois, la premiere n'est pas bonne car le vapro a fini de mesurer au bout du 10e cycle sans ecart de 5 (cf protocole)

Ptlp <- Ptlp[-69,]


write_csv(Ptlp, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/tlp.csv")

```


##majvla
```{r Vein Bafog, eval=FALSE, include=FALSE}
library(readxl)
library(forcats)
library(dplyr)
library(tidyverse)

Veindata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Scoffoni/results/Scoffoni_Bafog.csv") %>% select(Code, Genus, Species, midribVLA_S1,	SecondaryVLA_S1,	TertiaryVLA_S1,	MajVLA_S1,	midribVLA_S2,	SecondaryVLA_S2,	TertiaryVLA_S2,	MajVLA_S2) 


#averaging the two students' measurements
Veindata_tidy <- Veindata %>% mutate(MajVLA = (MajVLA_S1 + MajVLA_S2)/2, midribVLA = (midribVLA_S1+ midribVLA_S2)/2, SecondaryVLA = (SecondaryVLA_S1 + SecondaryVLA_S2) / 2, 	TertiaryVLA = (	TertiaryVLA_S1+ 	TertiaryVLA_S2)/2) %>% select(Code, Genus, Species, midribVLA , SecondaryVLA, TertiaryVLA ,  MajVLA) %>% na.omit()

# Code number 430 is not the good species. it was detected by Christine Scoffoni. Elimination de l'individu 430 

#444 value very high!!! outlier? D'après sack & scoffoni 2013 there are no MajVLA > 20
#Elimination 444 for MajVLA measurement only. The second student did an error, so we take the measurement of the first student

Veindata_tidy$midribVLA[Veindata_tidy$Code == 444] <- 0.164125881
Veindata_tidy$SecondaryVLA[Veindata_tidy$Code == 444] <- 0.82094895
Veindata_tidy$TertiaryVLA[Veindata_tidy$Code == 444] <- 2.286334552
Veindata_tidy$MajVLA[Veindata_tidy$Code == 444] <- 3.271409383




write_csv(Veindata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/majvla.csv")
```


## chemistry

```{r Chemistry Bafog}
library(readr)
#chemistry from all sites
Chemistry <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Grinding/Chemistry.csv") 

#only bafog
Chemistry_Bafog <- Chemistry %>% 
  filter(Code < 474) %>%
  filter(Code > 244)

write_csv(Chemistry_Bafog, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/chemistry.csv")
```


##stomata

Some Bafog images sizes are: *1392* x *1040* in BMP format: 
-X20 Scale conversion: 0.5 mm = 2145 pixel/mm; 0.65 mm *0.48 mm = 0.312 mm^2 image sizes
-X40 Scale conversion: 0.2 mm = 4250 pixel/mm; 0.33 mm * 0.24 mm = 0.0792 mm^2 image sizes


Some Bafog images sizes are also: *2560* x *1922* in BMP format: 
-X20 Scale conversion: 4566 pixel/mm; 0.56 mm *0.42 mm = 0.2352 mm^2 image sizes
-X40 Scale conversion: 9105 pixel/mm; 0.28 mm * 0.21 mm = 0.0588 mm^2 image sizes

Two scales because there was a change of camera for the microscope in between !
```{r Stomata Bafog}


stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Bafog/Rawdata/Donnees_clean/stomata_done/MetradicaBafog - stomata.csv")

stomata <- stomata %>% select(Code, Genus, Species, Count_x10, Count_x20, Count_x40, AncienneCamera, ImageResolution, Ancienne_ImageSizex20_mm2, Ancienne_ImageSizex40_mm2, Nouvelle_ImageSizex10_mm2, Nouvelle_ImageSizex20_mm2, Nouvelle_ImageSizex40_mm2, StomataDensity, Comment, Done) %>%
  rename(Comment_bis = Done)

#nouvelle Camera measurements
NouvelleCamera <- stomata %>% filter(AncienneCamera == 'non')

NouvelleCamera <- NouvelleCamera %>% 
  mutate(SD = ifelse(!is.na(Count_x20), Count_x20 / Nouvelle_ImageSizex20_mm2 , Count_x40 / Nouvelle_ImageSizex40_mm2)) %>%
  select(-Comment_bis, -Count_x10, -Ancienne_ImageSizex20_mm2, -Ancienne_ImageSizex40_mm2, -StomataDensity) 


#Ancienne
AncienneCamera <- stomata %>% filter(AncienneCamera == 'oui')

AncienneCamera <- AncienneCamera %>% 
  mutate(SD = ifelse(!is.na(Count_x20), Count_x20 / Ancienne_ImageSizex20_mm2 , Count_x40 / Ancienne_ImageSizex40_mm2)) %>%
  select(-Comment_bis, -Count_x10, -Nouvelle_ImageSizex20_mm2, -Nouvelle_ImageSizex40_mm2, -StomataDensity) 

#merge two data
stomata_tidy <- full_join(AncienneCamera, NouvelleCamera)

stomata_tidy <- stomata_tidy %>% 
  mutate(Name = paste0(Genus," ", Species)) %>%
  relocate(Name, .after = Species)

#330 there is a remark that it looks like a x10, but let's keep it x20
stomata_tidy$SD[stomata_tidy$Code == "330"] <- 62/0.2352

#425 there is a remark that it looks like a x10, but let's keep it x20
stomata_tidy$SD[stomata_tidy$Code == "425"] <- 49/0.2352


write_csv(stomata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/stomata.csv")

```

###plot to see if anymore outliers stand out


```{r outlier stomata bafog}
###plot all

stomata_all_plot <- ggplot(stomata_tidy) +
  aes(
    x = Name,
    y = SD,
    fill = Name
  ) +
  geom_boxplot() +
  scale_fill_hue(direction = 1) +
  theme_minimal()  +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Stomata_Bafog_all")

ggsave(stomata_all_plot, file = "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/Check_stomata/All_bafog_Stomata.jpg", width = 35, height = 20, units = "cm")

#per species loop
options(ggrepel.max.overlaps = Inf)
Name <- unique(stomata_tidy$Name)
for (i in SpCode) {

Stomata_Plotting <- stomata_tidy %>% filter(Name == i)
############# WITHOUT LABELS
PlotFam <- ggplot(data = Stomata_Plotting, aes(x = Name, y=SD)) + 
           geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
    
 scale_y_continuous(breaks = seq(from = 0.0, to = 900, by = 20), limits = c(0, 900))+
  
   geom_point(aes(color = Name), size = 2.5)  +

  ggtitle(paste0(i, ": Stomata"))
print(PlotFam)
#ggsave(PlotFam, file = paste("Outlier_analysis/images/Plots_Outliers_per_Family/gmin/", i,"gmin.jpg", sep = ""), width = 35, height = 20, units = "cm")
 
################# WITH LABELS 

PlotFam_label <- ggplot(data = Stomata_Plotting, aes(x = Name, y=SD)) + 
  geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
  scale_y_continuous(breaks = seq(from = 0.0, to = 900, by = 20), limits = c(0, 900))+
  
  
  geom_point(aes(color = Name), size = 2.5)   +
  
  
ggnewscale::new_scale_fill() + 
  
 ggrepel::geom_label_repel(aes(label = Code, fill = as.factor(Comment)),  data = Stomata_Plotting,
                  
                   nudge_y       = 0 ,
                   nudge_x       = 0,
                 size          = 2,
                  box.padding   = 1,
                  point.padding = 0.5,
                  
                  segment.size  = 0.3,
                  segment.color = "black",
                  direction     = "both") +
#                             
  ggtitle(paste0(i, ": Stomata"))


#print(PlotFam)  
print(PlotFam_label)

ggsave(PlotFam_label, file = paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/Check_stomata/" , i, "_Stomata.jpg"), width = 35, height = 20, units = "cm")

} 

```

## join with individuals
```{r}
Bafog_individuals <- read_csv("Cleaning/Clean_Bafog/Bafog_individuals.csv")


Gmin <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/gmin.csv") %>% 
  select(Code, gmin.slope) %>% rename(gmin = gmin.slope) 

TLP <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/tlp.csv") %>%
  select(Code, Ptlp) %>% rename(TLP = Ptlp)

Vein <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/majvla.csv")%>% select(-Genus, -Species)
#beware we eliminated individual 430 because leaves were not from the species we thought.

Vein$Code <- as.numeric(Vein$Code)

Chem <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/chemistry.csv")  %>% select(Code, X.N, X.C, `P..g.kg.`, `Ca..g.kg.`, `Na..g.kg.`, `K..g.kg.`) %>% rename(N = X.N, C = X.C, P =`P..g.kg.`, Ca= `Ca..g.kg.`, Na= `Na..g.kg.`, K= `K..g.kg.`)


LSWC <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/lswc.csv") %>% select(Code, LSWC)




Stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/stomata.csv") %>% select(Code, SD, Comment) %>% rename(Comment_Stomata = Comment)

 

fvfm <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/fvfm.csv") %>% select(Code, FvFm)
#beware we eliminated individual 415 because leaves were not healthy




Bafog <- left_join(Bafog_individuals, Gmin, by="Code")
Bafog <- left_join(Bafog, TLP, by="Code")
Bafog <- left_join(Bafog, Vein, by="Code")
Bafog <- left_join(Bafog, Chem, by="Code")
Bafog <- left_join(Bafog, LSWC, by="Code")
Bafog <- left_join(Bafog, Stomata, by="Code")
Bafog <- left_join(Bafog, fvfm, by="Code")


#elimination definitive de ces individus pour les raisons commentées
Bafog <- Bafog[!(Bafog$Code=="415"),] #fvfm too low to consider healthy leaves and therefore right measurements
Bafog <- Bafog[!(Bafog$Code=="430"),] #while looking at vein data, not the right species detected
Bafog <- Bafog[!(Bafog$Code=="261"),] #erreur bota

#doute bota for Code 416 and 425. Verified in the lab and validated to be measured.

Bafog$CommentLab[Bafog$Code == 416] <- "plus de doute bota"
Bafog$CommentLab[Bafog$Code == 425] <- "plus de doute bota"
```


##duplicate checks
```{r}
Bafog$Code[duplicated(Bafog$Code)] #no duplicated code.

```

##final bafog trait data
```{r}

write_csv(Bafog, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/Bafog.csv")
```


#III - Kaw 

**Est**: Samplings were done in plots KawGuyafor (1 ha) and Trésor from the 4<sup>th</sup> to  23<sup>rd</sup> of October 2021. Some trees were also sampled outside the plots. 

##indivuals

```{r Individuals_Kaw, eval=FALSE, include=FALSE}
library(readxl)
library(tidyverse)
library(dplyr)
library(rio)

#input
Kaw_individuals <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Kaw_individuals.csv") %>%
  select(Code, idTree, DateField, Genus, Species, Forest, Plot, SubPlot, FieldNbr, Habitat, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins, CrownPosition, DBH, Xutm, Yutm)

Kaw_individuals_completment_info <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/MetradicaKaw - traits.csv") %>% select(Code, Type)

Kaw_individuals_all <- left_join(Kaw_individuals, Kaw_individuals_completment_info)  %>% relocate(Type, .after = Habitat)

Kaw_individuals_all$Species[Kaw_individuals_all$Genus == 'Jacaranda'] <- 'copaia subsp. copaia'
Kaw_individuals_all$Species[Kaw_individuals_all$Species == 'opacum'] <- 'opacum subsp. rabelianum'


Kaw_individuals_all <- Kaw_individuals_all %>% mutate(Name= paste0(Genus, " ", Species)) %>% relocate(Name, .after = Species)
#looks already clean
#don't worry, 620 is an individual but no field information was recorded unfortunately.



#output
write.csv(Kaw_individuals_all, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/Kaw_individuals.csv")

```

##gmin

gmin parameters used:

-min of points: 5
-min time measurement: 1.4

to do: 
recheck 490, 638, 625, 627
```{r old gmin script, eval=FALSE, include=FALSE}
library(readr)
gmin <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/Gmin_Marion/documents/data/output/Kaw/ALLGminwithLA.csv")
gmin <- gmin %>% rename(LA= Leaf_area, gmin = gmin.slope_function) %>% select(Code, LA, gmin)

#check gmin

gmin$gmin[gmin$Code == 635] <- 4.23

gmin$gmin[gmin$Code == 481] <- 19.16 
gmin$gmin[gmin$Code == 514] <- 11.47 
gmin$gmin[gmin$Code == 554] <- 11.53 * 
gmin$gmin[gmin$Code == 541] <- 13.99 * 
gmin$gmin[gmin$Code == 594] <- 5.6987 * 
gmin$gmin[gmin$Code == 536] <- 8.16 
gmin$gmin[gmin$Code == 581] <- NA #erreur rawdata * 


gmin$Code[which(gmin$gmin >10)]
 #[1] 481 514 541 547 554 565 : ok thoses were rechecked

gmin$Code[which(gmin$gmin <1)]
#  [1] 490 : chryso : recheck this one
#520 522 578 582 586 588 593 595 597 614 624 646 647 649 these are ok

#missing codes are
#638
#625
#627


```

```{r new kaw gmin script post data cleaning with daniela}
gmin <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/traits/input/Gmin/input/Metradica/Kaw/output/Metradica_Kaw_Gmin_Clean_OUT.csv")

gmin$gmin.slope[gmin$Code == 554] <- 11.53 
gmin$gmin.slope[gmin$Code == 541] <- 13.99 
gmin$gmin.slope[gmin$Code == 594] <- 5.6987 
gmin$gmin.slope[gmin$Code == 581] <- NA #erreur rawdata *
```


```{r}

write_csv(gmin, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/gmin.csv")
```


### LA

All images 1328 ppp corresponding to 1600 dpi. 
Except : 564 et 565 resolution 1201 ppp corresponding to 1200 dpi.

Check resolution of images.
```{r resolution check kaw}
library(dplyr)
library(tidyverse)

path1 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/05102021")

path2 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/06102021")

path3 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/07102021")

path4 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/08102021")

path5 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/11102021")

path6 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/12102021")

path7 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/13102021")

path8 <- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/14102021")

path9<- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/18102021")

path10<- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/19102021")

path11<- list.files("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/20102021")


###

resolution1 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/05102021/",path1),tags = "XResolution")
ResolutionProblems1 <- resolution1 %>% filter(XResolution!=1328)

resolution2 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/06102021/",path2),tags = "XResolution")
ResolutionProblems2 <- resolution2 %>% filter(XResolution!=1328)

resolution3 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/07102021/",path3),tags = "XResolution")
ResolutionProblems3 <- resolution3 %>% filter(XResolution!=1328)


resolution4 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/08102021/",path4),tags = "XResolution")
ResolutionProblems4 <- resolution4 %>% filter(XResolution!=1328)

resolution5 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/11102021/",path5),tags = "XResolution")
ResolutionProblems5 <- resolution5 %>% filter(XResolution!=1328)

resolution6 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/12102021/",path6),tags = "XResolution")
ResolutionProblems6 <- resolution6 %>% filter(XResolution!=1328)

resolution7 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/13102021/",path7),tags = "XResolution")
ResolutionProblems7 <- resolution7 %>% filter(XResolution!=1328)

resolution8 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/14102021/",path8),tags = "XResolution")
ResolutionProblems8 <- resolution8 %>% filter(XResolution!=1328)

resolution9 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/18102021/",path9),tags = "XResolution")
ResolutionProblems9 <- resolution9 %>% filter(XResolution!=1328)

resolution10 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/19102021/",path10),tags = "XResolution")
ResolutionProblems10 <- resolution10 %>% filter(XResolution!=1328)

resolution11 <- exiftoolr::exif_read(paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/Scan_gmin/20102021/",path11),tags = "XResolution")
ResolutionProblems11 <- resolution11 %>% filter(XResolution!=1328)

```

##lswc

```{r lswc kaw}

LSWC <- read_xlsx("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/RWC/20211108_RWC_dry.xlsx")

LSWC <- LSWC %>% select(Unique_Code,FW, SW, DW) %>% rename(Code=Unique_Code)

LSWC$DW[LSWC$Code == 552] <- NA #problem measure DW

LSWC$DW <- as.numeric(LSWC$DW)

LSWC <- LSWC %>% mutate(LSWC = (SW-DW)/DW)

LSWC <- LSWC %>% select(Code, LSWC) %>% drop_na()

write_csv(LSWC, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/lswc.csv")

```


##tlp

```{r tlp kaw}

Ptlp <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1ywbd6_6DWfqCguahhEvs0qt0d3jAtsbt94xydm-maqI/edit#gid=733041492", range = "ptlp")

Ptlp <- Ptlp %>% select(-Ptlp, -Posm)

Ptlp_extra <- Ptlp %>% slice(185:192) #646 , 655, 654

Ptlp$C0 <- replace(Ptlp$C0, Ptlp$Code == "646", "505")
Ptlp$C0 <- replace(Ptlp$C0, Ptlp$Code == "655", "484")
Ptlp$C0 <- replace(Ptlp$C0, Ptlp$Code == "654", "536")

Ptlp$C0 <- as.numeric(Ptlp$C0)
  
Ptlp <- Ptlp %>% mutate(Posmo=(-2.5/1000)*C0) %>% mutate(Ptlp=(0.799*Posmo)-0.665)

Ptlp <- Ptlp %>% select(-DateCalibration, -Contamination, -DateField, -DateMesure)

library(stringr)

Ptlp <- Ptlp %>% 
  filter(!str_detect(Code, 'bis')) %>% filter(!str_detect(Code, 'ter'))

Ptlp$Code <- as.numeric(Ptlp$Code)

Ptlp_for_join <- Ptlp %>% select(Code, Ptlp)

sum(is.na(Ptlp_for_join$Ptlp)) #7 NA

Ptlp_for_join <- na.omit(Ptlp_for_join)

write_csv(Ptlp_for_join, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/tlp.csv")
```

## fvfm
```{r fvfm kaw}
library(readxl)
FvFm <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1ywbd6_6DWfqCguahhEvs0qt0d3jAtsbt94xydm-maqI/edit#gid=733041492", range = "fvfm")


FvFm$Code[which(FvFm$fvfm < 0.62 )]

#elimination de l'individu 537 car pas un fvfm qui nous renseigne sur un bon etat de sante de la feuille.

FvFm$fvfm[FvFm$Code == 537] <- NA

FvFm_clean <- FvFm %>% drop_na(fvfm) 

write_csv(FvFm_clean, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/fvfm.csv")
```

##stomata


Kaw images sizes are : *1392* x *1040* in BMP format: 
-X20 Scale conversion: 2470 pixel/mm; 0.56 mm *0.42 mm = 0.2352 mm^2 image sizes
-X40 Scale conversion: 4940 pixel/mm; 0.28 mm * 0.21 mm = 0.0588 mm^2 image sizes

```{r stomata kaw}
stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Est/Rawdata/stomates/MetradicaKaw - stomata.csv") 
                    
stomata <- stomata %>% select(Code, Genus, Species, Done, Done_x40, Count, ImageResolution, X10_echelle, X20_echelle, x40_echelle, StomataDensity, Comment) %>%
  rename(Comment_bis = Done)

stomata <- stomata %>% 
  mutate(Name = paste0(Genus," ", Species)) %>%
  relocate(Name, .after = Species)
  

stomata_tidy <- stomata %>% filter(!is.na(Count))

stomata_tidy$Comment_bis[stomata_tidy$Code == 617] <- stomata_tidy$Done_x40[stomata_tidy$Code == 617]

stomata_tidy <- stomata_tidy %>% select(-Done_x40)

library(forstringr)
stomata_tidy$Comment_bis <- str_right(stomata_tidy$Comment_bis, 3)

stomata_tidy$Comment_bis <- gsub("x", "",stomata_tidy$Comment_bis)

stomata_tidy$x40_echelle <- as.numeric(stomata_tidy$x40_echelle)

stomata_tidy <- stomata_tidy %>% mutate(SD = ifelse(Comment_bis == "20", Count / X20_echelle , Count / x40_echelle))


#522 there is a remark that it looks like a x10, but let's keep it x20, it's x20
stomata_tidy$SD[stomata_tidy$Code == "522"] <- 36/0.2352

#425 there is a remark that it looks like a x40. x20 is clearly an outlier

stomata_tidy$SD[stomata_tidy$Code == "491"] <- 27/0.0588
stomata_tidy$Comment[stomata_tidy$Code == "491"] <- "its x40"


write_csv(stomata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/stomata.csv")
```

###plot to see if anymore outliers stand out


```{r outlier stomata kaw}
###plot all

stomata_all_plot <- ggplot(stomata_tidy) +
  aes(
    x = Name,
    y = SD,
    fill = Name
  ) +
  geom_boxplot() +
  scale_fill_hue(direction = 1) +
  theme_minimal()  +
  theme(axis.text.x = element_text(angle = 45)) +
  ggtitle("Stomata_Kaw_all")

ggsave(stomata_all_plot, file = "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/Check_stomata/All_Kaw_Stomata.jpg", width = 35, height = 20, units = "cm")

#per species loop
options(ggrepel.max.overlaps = Inf)
Name <- unique(stomata_tidy$Name)
for (i in Name) {

Stomata_Plotting <- stomata_tidy %>% filter(Name == i)
############# WITHOUT LABELS
PlotFam <- ggplot(data = Stomata_Plotting, aes(x = Name, y=SD)) + 
           geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
    
 scale_y_continuous(breaks = seq(from = 0.0, to = 1600, by = 20), limits = c(0, 1600))+
  
   geom_point(aes(color = Name), size = 2.5)  +

  ggtitle(paste0(i, ": Stomata"))
print(PlotFam)
#ggsave(PlotFam, file = paste("Outlier_analysis/images/Plots_Outliers_per_Family/gmin/", i,"gmin.jpg", sep = ""), width = 35, height = 20, units = "cm")
 
################# WITH LABELS 

PlotFam_label <- ggplot(data = Stomata_Plotting, aes(x = Name, y=SD)) + 
  geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
  scale_y_continuous(breaks = seq(from = 0.0, to = 1600, by = 20), limits = c(0, 1600))+
  
  
  geom_point(aes(color = Name), size = 2.5)   +
  
  
ggnewscale::new_scale_fill() + 
  
 ggrepel::geom_label_repel(aes(label = Code, fill = as.factor(Comment)),  data = Stomata_Plotting,
                  
                   nudge_y       = 0 ,
                   nudge_x       = 0,
                 size          = 2,
                  box.padding   = 1,
                  point.padding = 0.5,
                  
                  segment.size  = 0.3,
                  segment.color = "black",
                  direction     = "both") +
#                             
  ggtitle(paste0(i, ": Stomata"))


#print(PlotFam)  
print(PlotFam_label)

ggsave(PlotFam_label, file = paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/Check_stomata/" , i, "_Stomata.jpg"), width = 35, height = 20, units = "cm")

} 

#650 take out?
#581 not the good species?
#laetia procera really high, 546?
#642 tac mel trop haut?
```

##majvla
```{r Vein Kaw, eval=FALSE, include=FALSE}
library(readxl)
library(forcats)
library(dplyr)
library(tidyverse)

Veindata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Scoffoni/results/Scoffoni_Kaw.csv") %>% select(Code, Genus, Species, midribVLA_S1,	SecondaryVLA_S1,	TertiaryVLA_S1,	MajVLA_S1,	midribVLA_S2,	SecondaryVLA_S2,	TertiaryVLA_S2,	MajVLA_S2) 


#averaging the two students' measurements
Veindata_tidy <- Veindata %>% mutate(MajVLA = (MajVLA_S1 + MajVLA_S2)/2, midribVLA = (midribVLA_S1+ midribVLA_S2)/2, SecondaryVLA = (SecondaryVLA_S1 + SecondaryVLA_S2) / 2, 	TertiaryVLA = (	TertiaryVLA_S1+ 	TertiaryVLA_S2)/2) %>% select(Code, Genus, Species, midribVLA , SecondaryVLA, TertiaryVLA ,  MajVLA) %>% na.omit()


write_csv(Veindata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/majvla.csv")
```

##chemistry

```{r Chemistry Kaw}
library(readr)
#chemistry from all sites
Chemistry <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Grinding/Chemistry.csv") 

#only kaw
Chemistry_Kaw <- Chemistry %>% 
  filter(Code < 657) %>%
  filter(Code > 473)

write_csv(Chemistry_Kaw, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/chemistry.csv")
```

## join with individuals
```{r}
Kaw_individuals <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/Kaw_individuals.csv") %>% select(-`...1`)

Gmin <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/gmin.csv") %>% 
  select(Code, gmin.slope) %>% rename(gmin = gmin.slope) 

TLP <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/tlp.csv") %>%
  select(Code, Ptlp) %>% rename(tlp = Ptlp)

Vein <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/majvla.csv")%>% select(-Genus, -Species)

Vein$Code <- as.numeric(Vein$Code)

Chem <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/chemistry.csv")  %>% select(Code, X.N, X.C, `P..g.kg.`, `Ca..g.kg.`, `Na..g.kg.`, `K..g.kg.`) %>% rename(N = X.N, C = X.C, P =`P..g.kg.`, Ca= `Ca..g.kg.`, Na= `Na..g.kg.`, K= `K..g.kg.`)


LSWC <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/lswc.csv") %>% select(Code, LSWC)

Stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/stomata.csv") %>% select(Code, SD, Comment) %>% rename(Comment_Stomata = Comment)

fvfm <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/fvfm.csv") %>% select(Code, fvfm)
#beware we eliminated individual 537 because leaves were not healthy


Kaw <- left_join(Kaw_individuals, Gmin, by="Code")
Kaw <- left_join(Kaw, TLP, by="Code")
Kaw <- left_join(Kaw, Vein, by="Code")
Kaw <- left_join(Kaw, Chem, by="Code")
Kaw <- left_join(Kaw, LSWC, by="Code")
Kaw <- left_join(Kaw, Stomata, by="Code")
Kaw <- left_join(Kaw, fvfm, by="Code")


#elimination definitive de ces individus pour les raisons commentées
Kaw <- Kaw[!(Kaw$Code=="537"),] #fvfm too low to consider healthy leaves and therefore right measurements

#skipped code numbers without any individual measurements

#509; 532 ; 533; 568 ; 569

Kaw <- Kaw[!(Kaw$Code=="509"),]
Kaw <- Kaw[!(Kaw$Code=="532"),]
Kaw <- Kaw[!(Kaw$Code=="533"),]
Kaw <- Kaw[!(Kaw$Code=="568"),]
Kaw <- Kaw[!(Kaw$Code=="569"),]


#don't worry, 620 is an individual but no field information was recorded unfortunately.
```


##final kaw trait data
```{r}

write_csv(Kaw, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/Kaw.csv")
```


#IV - FTH : Paracou - Second campaign

For this second campaign, the purpose was to complete the sampling of the first field campaign at Paracou's site. This was done through the HydroITV project (*sylvainschmitt.github.io/hydroITV/*) carried out in September 2021.


##individuals

Only 35 individuals from the 100 sampled for the HydroITV project were common to the Metradica project.

```{r}
FTH_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/information_sites_and_tree_individuals/FieldSheets/input/Metradica/input/Paracou/individuals_FTH2021.csv")

FTH_individuals$Species[FTH_individuals$Genus == 'Jacaranda'] <- 'copaia subsp. copaia'

FTH_individuals <- FTH_individuals %>%
          mutate(Name = paste0(Genus, " ", Species)) %>%
          relocate(Name, .after = Species)

write_csv(FTH_individuals, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_individuals.csv")
```

##gmin

gmin realised by hand by the students
```{r FTH manual student}
gmin_students <- read_xlsx("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/hydroITV_FTH_20220114.xlsx", sheet = "ind_gmin")

gmin_students <- gmin_students %>% rename(CodeFTH = FieldCode, gmin_manual_student = gmin) %>% select(CodeFTH, gmin_manual_student)

gmin_students_suite <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/Enseignement/FTH2021/GroupeMarion/Data/gmin/Calculgmin/Gmin_FTHwithLA94.csv", sep = ";") %>% select(Code, gmin_manuel) %>% rename(CodeFTH = Code, gmin_manual_student = gmin_manuel)

gmin_students_all <- rbind(gmin_students, gmin_students_suite)
```


gmin function developped by Daniela Krebber. 

```{r FTH function DK}
gmin_DK <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/traits/input/Gmin/input/Metradica/Paracou/output/Metradica_FTH_Gmin_Clean_OUT.csv")

```

Comparaison of the gmin calculation done by the students and gmin measurement calculated by D. Krebber function.

```{r FTH gmin compare}
A <- gmin_students_all %>% select(CodeFTH, gmin_manual_student)

B <- gmin_DK %>% select(CodeFTH, gmin.slope) 
  
C <- left_join(B,A, by = "CodeFTH") %>% mutate(Diff = abs(gmin_manual_student - gmin.slope))

C$CodeFTH <- as.character(C$CodeFTH)

Diff_graph <- ggplot(C) +
  aes(
    x = gmin.slope,
    y = gmin_manual_student,
    colour = CodeFTH
  ) +
  geom_point(shape = "circle", size = 1.5) +
  scale_color_hue(direction = 1) +
  theme_minimal() + 
  geom_abline()

library(plotly)
library(ggplot2)
ggplotly(Diff_graph)

#Stong difference are found for CodeFTH 4 et 30 which are no on the 1:1 line.

```


*CodeFTH 4 was noted: Code_Meas_Quality = 3* 
*CodeFTH 30 was noted: Code_Meas_Quality = 2* **potential_measurement_error**

For these values a different - less conservative R2 selection critera was used.
We keep track of this in the Measurement_quality_Code.

- Code 1: Good original criteria - at least 4 points, & 1.4 h of consecutive measurements
- CODE 2: Instead of minimum measurement time of 1.4 h from which the slope is calculated only 1 h could be chosen 
- CODE 3: Instead of minimum measurements 4 from which the slope is calculated only 3 could be chosen 
- CODE 4: Even after being more liberal with the R2 selection criteria R2 is still not good 





###final gmin FTH data
```{r final gmin FTH data for metradica}
final_FTH_gmin <- gmin_DK #I conserved the gmin calculated by D.K. function. 

#These 2 measurements for CodeFTH4 and 30 are really not optimal: I decided to remove them from my gmin FTH analysis.

final_FTH_gmin <- final_FTH_gmin[!(final_FTH_gmin$CodeFTH=="4"),]
final_FTH_gmin <- final_FTH_gmin[!(final_FTH_gmin$CodeFTH=="30"),]

write_csv(final_FTH_gmin, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_gmin.csv")
```


##lswc
```{r}
RWCMetradica_FTH<- readxl::read_xlsx("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/Enseignement/FTH2021/GroupeMarion/Data/rwc/RWC_20211001.xlsx")

 

RWCMetradica_FTH <- RWCMetradica_FTH[!is.na(RWCMetradica_FTH$DW),]

```


### rename column names 
```{r}
names(RWCMetradica_FTH)
```

Check DataStructure of the columns
```{r}
str(RWCMetradica_FTH) #columns are ok in structure
```


### get rid of unnecessary rows where there is no corresponding sample 

```{r}

RWCMetradica_FTH <- RWCMetradica_FTH %>% mutate(Code_skipped = ifelse(is.na(`FW+BW`) &
                                            is.na(FW) &                                 
                                           is.na(SW) & 
                                           is.na(DW), 1, 0))

# only keep rows that are samples
RWCMetradica_FTH <- RWCMetradica_FTH %>% filter(Code_skipped != 1)

#checks

RWC  <- RWCMetradica_FTH  %>% 
  select(Code, FW, SW, DW, Comment_Lab, Comment_Weight_Bag, Comment_Field) %>% 
  mutate(C = SW - FW) %>% 
  mutate(C2 = SW - DW)

RWC$Code[which(RWC$C < 0 )] #juste pour regarder quand SW- FW < 0 ce qui ne devrait pas arriver.

# [1]  3  7 14 26 27 28 51 66 74 82 83 85 90 94

#but no special comments

RWC$Code[which(RWC$C2 < 0 )] #juste pour regarder quand SW- DW < 0 , ok nothing

```


###calculate LSWC

```{r}
RWCMetradica_FTH <-RWCMetradica_FTH %>%
  mutate(LSWC = (SW - DW)/ DW) 

```

##final fth lswc

```{r}
final_FTH_lswc <- RWCMetradica_FTH %>% 
  select(Code, FW, SW, DW, LSWC) %>%
  rename(CodeFTH = Code)

#recoupe avec les individus de metradica seulement
FTH_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_individuals.csv")

lswc <- left_join(FTH_individuals, final_FTH_lswc)

write_csv(lswc, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_lswc.csv")
```


#stomata

All Paracou FTH images sizes are: *1392* x *1040* in BMP format: 
-X20 Scale conversion: 2145 pixel/mm; 0.65 mm *0.48 mm = 0.312 mm^2 image sizes
-X40 Scale conversion: 4250 pixel/mm; 0.33 mm * 0.24 mm = 0.0792 mm^2 image sizes

```{r stomata FTH}
stomata_fth <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Metradica_Paracou/Rawdata/Donnees_clean/Metradica_stomates/MetradicaParacou - stomata.csv") 

stomata_fth <- stomata_fth %>% select(Code, Name, -Countx10, Countx20, Countx40, ImageSizex20_mm2, ImageSizex40_mm2,StomatalDensity_Stomate_mm2, Comment_Stomata) 


stomata_tidy <- stomata_fth %>% filter(Code > 244)

stomata_tidy <- stomata_tidy %>% mutate(SD = ifelse(!is.na(Countx20), Countx20 / ImageSizex20_mm2 , Countx40 / ImageSizex40_mm2)) %>% filter(!is.na(SD))

write_csv(stomata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_stomata.csv")
```

```{r outlier stomata FTH checks}
#looking at outliers
#from Machado et al 2021 (130 - 1708 mm^-2 for the Stomatal Density range)

stomata_all_plot <- ggplot(stomata_tidy) +
  aes(
    x = Name,
    y = SD,
    fill = Name
  ) +
  geom_boxplot() +
  scale_fill_hue(direction = 1) +
  theme_minimal()  +
  ggtitle("Stomata_Paracou_all_FTH")

ggsave(stomata_all_plot, file = "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Check_stomata/FTH/FTH_Stomata.jpg", width = 35, height = 20, units = "cm")

#per species loop
options(ggrepel.max.overlaps = Inf)
Name <- unique(stomata_tidy$Name)
for (i in Name) {

Stomata_Plotting <- stomata_tidy %>% filter(Name == i)
############# WITHOUT LABELS
PlotFam <- ggplot(data = Stomata_Plotting, aes(x = Name, y=SD)) + 
           geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
    
 scale_y_continuous(breaks = seq(from = 0.0, to = 900, by = 20), limits = c(0, 900))+
  
   geom_point(aes(color = Name), size = 2.5)  +

  ggtitle(paste0(i, ": Stomata"))
print(PlotFam)
#ggsave(PlotFam, file = paste("Outlier_analysis/images/Plots_Outliers_per_Family/gmin/", i,"gmin.jpg", sep = ""), width = 35, height = 20, units = "cm")
 
################# WITH LABELS 

PlotFam_label <- ggplot(data = Stomata_Plotting, aes(x = Name, y=SD)) + 
  geom_boxplot(aes()) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) +
  scale_y_continuous(breaks = seq(from = 0.0, to = 900, by = 20), limits = c(0, 900))+
  
  
  geom_point(aes(color = Name), size = 2.5)   +
  
  
ggnewscale::new_scale_fill() + 
  
 ggrepel::geom_label_repel(aes(label = Code, fill = as.factor(Comment_Stomata)),  data = Stomata_Plotting,
                  
                   nudge_y       = 0 ,
                   nudge_x       = 0,
                 size          = 2,
                  box.padding   = 1,
                  point.padding = 0.5,
                  
                  segment.size  = 0.3,
                  segment.color = "black",
                  direction     = "both") +
#                             
  ggtitle(paste0(i, ": Stomata"))


#print(PlotFam)  
print(PlotFam_label)

ggsave(PlotFam_label, file = paste0("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Check_stomata/FTH/" , i, "_Stomata.jpg"), width = 35, height = 20, units = "cm")

} 

#outliers detection:
#a more complete check would be after join all sites, because some might seem outliers but let's see the rest as well
#no removal at theis stage


```



#fvfm
```{r}
fvfm <- read_xlsx("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/Enseignement/FTH2021/GroupeMarion/Data/hydroITV_FTH.xlsx", sheet = "ind_soft") %>%
  select(Sample, FvFm) %>%
  na.omit() %>%
  rename(CodeFTH =Sample)

#recoupe avec les individus de metradica seulement
FTH_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_individuals.csv")

fvfm_tidy <- left_join(FTH_individuals, fvfm)

A <- fvfm_tidy$CodeFTH[which(fvfm_tidy$FvFm > 1 )]

# 13 15 16 21 24 30 31 38 41 43 44 47 49 58 60 63 65 67 69 70 75 77

#pour des raisons d'efficacité pour rentrer les valeurs brutes, seulement les 3 chiffres après la virgule étaient rentrés.

#correction
fvfm_tidy <- fvfm_tidy %>% 
  mutate(FvFm_corr = case_when(FvFm < 1 ~ FvFm,
                        FvFm > 1  ~ FvFm *0.001))

fvfm_tidy <- fvfm_tidy %>% select(Code, FvFm_corr) %>% rename(fvfm = FvFm_corr)

write_csv(fvfm_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_fvfm.csv")
```

#tlp

```{r}
tlp <- read_xlsx("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/Enseignement/FTH2021/GroupeMarion/Data/hydroITV_FTH.xlsx", sheet = "ind_ptlp") %>% rename(CodeFTH = Sample, tlp =Ptlp)

#recoupe avec les individus de metradica seulement
FTH_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_individuals.csv")

tlp <- left_join(FTH_individuals, tlp)

write_csv(tlp, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_tlp.csv")
```


#chemistry
```{r chem fth}
library(readr)
#chemistry from all sites
Chemistry <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Grinding/Chemistry.csv") 

#only fth
Chemistry_FTH <- Chemistry %>% 
  filter(Code > 656) %>%
  filter(Code < 692)

write_csv(Chemistry_FTH, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_chemistry.csv")
```

#majvla

```{r majvla FTH}

Veindata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Scoffoni/results/Scoffoni_FTHdata.csv") %>% select(Code, spName, midribVLA_S1,	SecondaryVLA_S1,	TertiaryVLA_S1,	MajVLA_S1,	midribVLA_S2,	SecondaryVLA_S2,	TertiaryVLA_S2,	MajVLA_S2) 


#averaging the two students' measurements
Veindata_tidy <- Veindata %>% mutate(MajVLA = (MajVLA_S1 + MajVLA_S2)/2, midribVLA = (midribVLA_S1+ midribVLA_S2)/2, SecondaryVLA = (SecondaryVLA_S1 + SecondaryVLA_S2) / 2, 	TertiaryVLA = (	TertiaryVLA_S1+ 	TertiaryVLA_S2)/2) %>% select(Code, spName, midribVLA , SecondaryVLA, TertiaryVLA ,  MajVLA) %>% na.omit()


write_csv(Veindata_tidy, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_majvla.csv")
```


#join all fth traits
```{r}
FTH_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_individuals.csv")


Gmin <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_gmin.csv") %>% 
  select(Code, gmin.slope) %>% rename(gmin = gmin.slope) 

TLP <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_tlp.csv") %>%
  select(Code, tlp) 

Vein <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_majvla.csv") %>% select(-spName)

Vein$Code <- as.numeric(Vein$Code)

Chem <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_chemistry.csv")  %>% select(Code, X.N, X.C, `P..g.kg.`, `Ca..g.kg.`, `Na..g.kg.`, `K..g.kg.`) %>% rename(N = X.N, C = X.C, P =`P..g.kg.`, Ca= `Ca..g.kg.`, Na= `Na..g.kg.`, K= `K..g.kg.`)


LSWC <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_lswc.csv") %>% select(Code, LSWC)

Stomata <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_stomata.csv") %>% select(Code, SD, Comment_Stomata)

fvfm <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH_fvfm.csv") %>% select(Code, fvfm)

FTH <- left_join(FTH_individuals, Gmin, by="Code")
FTH <- left_join(FTH, TLP, by="Code")
FTH <- left_join(FTH, Vein, by="Code")
FTH <- left_join(FTH, Chem, by="Code")
FTH <- left_join(FTH, LSWC, by="Code")
FTH <- left_join(FTH, Stomata, by="Code")
FTH <- left_join(FTH, fvfm, by="Code")

##final fth trait data for metradica

write_csv(FTH, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH.csv")
```


#V -  Combine trait data for Metradica 

##combine paracou data
```{r}
Paracou_first_campaign <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Paracou.csv") %>% select(-FW, -SW, -DW) %>% mutate(Name = paste0(Genus, " ", Species)) %>% relocate(Name, .after = Species) %>% rename(fvfm =FVFM, tlp =TLP) %>% relocate(c(DateField,Forest, Plot, SubPlot, FieldNbr, Habitat, Type), .after = idTree)

Paracou_FTH <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/FTH.csv") %>% select(-CodeFTH)

Paracou <- rbind(Paracou_first_campaign, Paracou_FTH)

write_csv(Paracou, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Paracou_both_campaigns.csv")


```

##merge with kaw and bafog

```{r}

Paracou <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Paracou/Paracou_both_campaigns.csv")

names(Paracou)

Kaw <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Kaw/Kaw.csv") %>% select(-DBH, -Xutm, -Yutm)

Paracou_Kaw <- rbind(Paracou, Kaw)

Bafog <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Clean_Bafog/Bafog.csv") %>% rename(SubPlot = Subplot, tlp= TLP, fvfm = FvFm) %>% select(-DBH, -Circ, -CommentField, -CommentLab, -`...1`)

Paracou_Kaw_Bafog <- rbind(Paracou_Kaw, Bafog)
#High/Low/Middle

#homogenization des terminaison
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "top"] <- 'High'
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "Sup"] <- 'High'
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "high"] <- 'High'
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "Inf"] <- 'Low'
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "low"] <- 'Low'
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "mid"] <- 'Middle'
Paracou_Kaw_Bafog$CrownPosition[Paracou_Kaw_Bafog$CrownPosition == "Mid"] <- 'Middle'
Paracou_Kaw_Bafog$Type[Paracou_Kaw_Bafog$Type == "Generalists"] <- 'Generalist'


#final Metradica data, finally

write_csv(Paracou_Kaw_Bafog, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Final/Metradica.csv")

```


VI - Additional traits

************************
RECHECK Stomatal density and the conversions!!!
*******************

## Gmax

Theoretical maximum stomatal conductance in $$mol H_2O m^{-2} s^{-1}$$ 


$$ g_{max} = \frac{SD*d_w*amax} {v * (pd + \pi/2 * sqrt(amax/ \pi))} $$
For normalization of the values, the constants *dw* and *v* represent the values at 25°C (24.9 × 10−6 m2 s−1) and 24.4 × 10−3 m3 mol−1, respectively). *pd* or *l*. amax was calculated as π(*StomatalPoreLength*/2)^2 , according to Franks et al. (2009) for a fully opened stomata was taken as L/4 assuming guard cells inflate to circular
cross-section (Franks et al., 2009).

pd = is the depth of the stomatal pore (m, approximated as W/2 for fully inflated guard cells (Franks & Farquhar (2007)) = pore depth of fully opened stomata = W/2 => m

Small stomatal size can provide a reduction in total leaf pore area and might also facilitate faster aperture response (Franks and Beerling, 2009; Drake et al., 2013; Lawson and Blatt, 2014). 

```{r}
Gmax_subset_data <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Divers/Gmax/Stomates_gmax.csv",fileEncoding = "Windows-1252") %>%
  rename(Code = Code_ind, StomatalPoreLength=lp..mm., StomatalLength=L..mm., StomatalWidth=W..mm.) %>%
  select(Code, Stomate, -Species, StomatalPoreLength, StomatalLength, StomatalWidth)

StomataDensity <-  read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Final/Metradica.csv") %>%
  select(Code, Genus, Species, Name, gmin, SD)

Gmax_subset_data <- left_join(Gmax_subset_data, StomataDensity, by = "Code")

#calculate SS

Gmax_subset_data <- Gmax_subset_data %>%
  mutate(SS= StomatalLength * StomatalWidth) %>%
  mutate(amax = pi*((StomatalPoreLength/1000)/2)^2) %>% #en mètre en divisant par 1000
  mutate(pd = (StomatalWidth/1000)/2) %>% #en mètre en divisant par 1000
  mutate(gmax = (SD*(10^6)*24.9*10^(-6)*amax)/((24.4*10^(-3))*(pd+(pi/2)*sqrt(amax/pi))))

#mean gmax per individual

Gmax_subset_data <- Gmax_subset_data %>%
  group_by(Code) %>%
  summarise(gmax_mean_indv = mean(gmax))

#merge with the data

Gmax_subset_data <- left_join(Gmax_subset_data, StomataDensity) %>%
  na.omit()

Gmax <- Gmax_subset_data %>%
  select(Code, gmax_mean_indv) %>%
  rename(gmax= gmax_mean_indv)

#there are 149 individuals for whom gmax has been calculated.
```

##merge gmax with final metradica
```{r}
Metradica <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Final/Metradica.csv") 

Metradica <- left_join(Metradica, Gmax)

write_csv(Metradica, "C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Cleaning/Final/Metradica.csv")
```

