---
title: "05-Paper Analyses"
author: "Marion Boisseaux"
date: "2023-03-03"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Paper Analyses

```{r libraries, include=FALSE}
library(ape)
library(tidyverse)
library(dplyr)
library(ggfortify)
library(corrplot) 
library(ggpubr) #for stats compare means on ggplot
#devtools::install_github("kassambara/ggpubr")
library(ggplot2)
library(agricolae)
library(FactoMineR)
library(factoextra)
library(Factoshiny)
library(vegan)
library(rstatix)
library(readxl)
library(lme4)
library(ggeffects) #draw plots of models
library(nlme)
library(gridExtra)
library(rio)
library(multcomp) #for lmer model to do anovas
library(lmerTest) #same
library(emmeans)#same
library(ggplotify)
library(car)
library(kableExtra)
library(gt)
```

My functions
```{r functions}
log_abs_trans <- function() {
    scales::trans_new(
        name = "log_abs", 
        transform = function(x) log(abs(x)), 
        inverse = function(x) exp(x));
}

library("scales")
reverselog_trans <- function(base = exp(1)) {
    trans <- function(x) -log(x, base)
    inv <- function(x) base^(-x)
    trans_new(paste0("reverselog-", format(base)), trans, inv, 
              log_breaks(base = base), 
              domain = c(1e-100, Inf))
}

library(broom)
get_formula <- function(model) {
  
  broom::tidy(model)[, 1:2] %>%
    mutate(sign = ifelse(sign(estimate) == 1, ' + ', ' - ')) %>% #coeff signs
    mutate_if(is.numeric, ~ abs(round(., 2))) %>% #for improving formatting
    mutate(a = ifelse(term == '(Intercept)', paste0('y ~ ', estimate), paste0(sign, estimate, ' * ', term))) %>%
    summarise(formula = paste(a, collapse = '')) %>%
    as.character
  
}

cv_eff <- function(traits){
  if(any(is.na(traits)))
    traits=traits[!is.na(traits)]
  N=length(traits)
  y_bar=mean(traits)
  s2_hat=var(traits)
  cv_2=s2_hat/y_bar^2
  cv_1=sqrt(cv_2)
  gamma_1=sum(((traits-y_bar)/s2_hat^0.5)^3)/N
  gamma_2=sum(((traits-y_bar)/s2_hat^0.5)^4)/N
  bias=cv_2^(3/2)/N*(3*cv_2^0.5-2*gamma_1)
  bias2=cv_1^3/N-cv_1/4/N-cv_1^2*gamma_1/2/N-cv_1*gamma_2/8/N
  cv1=sd(traits)/mean(traits)
  cv4=cv_1-bias2
  re=cv4
  return(list(cv= re, eff = N))
} 


cv <- function(traits){
  if(any(is.na(traits)))
    traits=traits[!is.na(traits)]
  N=length(traits)
  y_bar=mean(traits)
  s2_hat=var(traits)
  cv_2=s2_hat/y_bar^2
  cv_1=sqrt(cv_2)
  gamma_1=sum(((traits-y_bar)/s2_hat^0.5)^3)/N
  gamma_2=sum(((traits-y_bar)/s2_hat^0.5)^4)/N
  bias=cv_2^(3/2)/N*(3*cv_2^0.5-2*gamma_1)
  bias2=cv_1^3/N-cv_1/4/N-cv_1^2*gamma_1/2/N-cv_1*gamma_2/8/N
  cv1=sd(traits)/mean(traits)
  cv4=cv_1-bias2
  re=cv4
  return(re)
}

```

Colors 
```{r colors}
#From color blind palette
library(ggpubfigs)
#from palette ito_seven
#E79F02 #orange for TF
#56B4E9 #blue for SF
#009E72 #green for Generalists
```

## Data

*From the original complete dataset, selecting 21 focal species. Transforming data in log.*

```{r Data log subset, message=FALSE, warning=FALSE}

# data

library(dplyr)
Metradica_log <- read.csv("C://Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/ALL/Final_Metradica_OUT_30112022.csv") %>% 
  dplyr::select(Code, Genus, Species, Name, Habitat, Type, Forest, Gmin, TLP, LSWC, MajVLA, Nitrogen, Carbon, Phosphorous, Potassium, SD, TWI, DBH) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "Nitrogen", "Carbon", "Phosphorous", "Potassium", "SD", "DBH", "TWI"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "Nitrogen", "Carbon", "Phosphorous", "Potassium", "SD", "DBH", "TWI"), log) %>% 
  mutate(TLP = -TLP) %>%
  rename(K= Potassium,
         P = Phosphorous,
         C = Carbon, 
         N= Nitrogen)

sub_data_TF <- Metradica_log %>%
  filter(Name %in% c("Dicorynia_guianensis", "Iryanthera_sagotiana", "Gustavia_hexapetala", "Licania_membranacea", "Poraqueiba_guianensis", "Virola_michelii")) %>% filter(Habitat == "TF")

sub_data_SF <- Metradica_log %>%
  filter(Name %in% c("Eschweilera_coriacea","Eperua_falcata", "Iryanthera_hostmannii", "Laetia_procera", "Protium_opacum subsp. rabelianum", "Pterocarpus_officinalis", "Symphonia_globulifera", "Virola_surinamensis", "Carapa_surinamensis")) %>% filter(Habitat == "BF")

sub_data_G <-  Metradica_log %>%
  filter(Name %in% c("Bocoa_prouacensis", "Conceveiba_guianensis", "Jacaranda_copaia subsp. copaia", "Hymenopus_heteromorphus", "Protium_stevensonii", "Tachigali_melinonii"))

sub_data <- bind_rows(sub_data_TF, sub_data_SF, sub_data_G)

sub_data <- sub_data %>% mutate(Type= ifelse(Name == 'Virola_michelii','TF',Type))

sub_data <- sub_data %>% mutate(Type= ifelse(Name == 'Eschweilera_coriacea','BF',Type))

Metradica_log <- sub_data #552 indv

```

## Trait variation - raw data 

No imputation. Vizualizing trait variation.

```{r Data not log subset}

# data

library(dplyr)
Metradica <- read.csv("C://Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/ALL/Final_Metradica_OUT_30112022.csv") %>% 
  dplyr::select(Code, Genus, Species, Name, Habitat, Type, Forest, Plot, Gmin, TLP, LSWC, MajVLA, Nitrogen, Carbon, Phosphorous, Potassium, SD, TWI, DBH) %>%
  rename(K= Potassium,
         P = Phosphorous,
         C = Carbon, 
         N= Nitrogen)

sub_data_TF <- Metradica %>%
  filter(Name %in% c("Dicorynia_guianensis", "Iryanthera_sagotiana", "Gustavia_hexapetala", "Licania_membranacea", "Poraqueiba_guianensis", "Virola_michelii")) %>% filter(Habitat == "TF")

sub_data_SF <- Metradica %>%
  filter(Name %in% c("Eschweilera_coriacea","Eperua_falcata", "Iryanthera_hostmannii", "Laetia_procera", "Protium_opacum subsp. rabelianum", "Pterocarpus_officinalis", "Symphonia_globulifera", "Virola_surinamensis", "Carapa_surinamensis")) %>% filter(Habitat == "BF")

sub_data_G <-  Metradica %>%
  filter(Name %in% c("Bocoa_prouacensis", "Conceveiba_guianensis", "Jacaranda_copaia subsp. copaia", "Hymenopus_heteromorphus", "Protium_stevensonii", "Tachigali_melinonii"))

sub_data <- bind_rows(sub_data_TF, sub_data_SF, sub_data_G)

sub_data <- sub_data %>% mutate(Type= ifelse(Name == 'Virola_michelii','TF',Type))

sub_data <- sub_data %>% mutate(Type= ifelse(Name == 'Eschweilera_coriacea','BF',Type))

Metradica <- sub_data

#write.csv(Metradica, "Subset.csv")
```

```{r Trait distribution coord_flip}


data <- Metradica %>%
  dplyr::select(Name, Type, Gmin, TLP, LSWC, MajVLA, N, C, P, K, SD) %>% 
  reshape2::melt(c("Name", "Type"), variable.name = "Trait")

data$Type <- factor(data$Type, levels = c("BF", "TF", "Generalist")) 
p <-  data %>%
  mutate(Trait = as.character(Trait)) %>% 
  mutate(Trait = dplyr::recode(Trait, "Gmin" = "g[min]~(mmol%.%m^{-2}%.%s^{-1})", "TLP" = "pi[tlp]~(MPa)", "C"= "C~('%')", "N" = "N~('%')", "K"= "K~(g%.%kg^{-1})", "LSWC" = "LSWC~('%')", "MajVLA" = "MajVLA~(mm%.%mm^{-2})", "P" = "P~(g%.%kg^{-1})", "SD" = "SD~(mm^{-2})")) %>% 
  left_join(dplyr::select(data, Type, Name) %>%
              unique() %>%
              arrange(Type, Name) %>%
              mutate(order_graph = 1:n())) %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x = reorder(Name, order_graph), y= value)) +
  geom_boxplot(aes(fill = Type),
  #              alpha = 0.5, col = "lightgrey") +
  #geom_violin(aes(fill = Type),
               alpha = 0.5, col = "lightgrey") +
  scale_fill_manual(name = "Species preference", 
                    values = c("TF" = "#E79F02", #orange for TF
                                "BF" =  "#56B4E9", #blue for SF
                                "Generalist" = "#009E72"),  #green for Generalists
                    labels = c("TF" = "TF specialist",
                               "Generalist" = "Generalist", 
                               "BF" = "SF specialist")) +
  facet_wrap(~ Trait, scales = "free_x", label = label_parsed) +
  theme_minimal() +
  coord_flip() +
  theme(axis.text.y = element_text(face = "italic"), axis.title = element_blank(),legend.position = "bottom") 

ggsave(filename = "Trait Distribution.png", plot = p, bg = "white", width = 10, height = 8, dpi = 600)
```


## Exploring TWI

```{r}
sub_data <- read.csv("Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv")
sub_data$Forest <- as.factor(sub_data$Forest)
sub_data$Habitat <- dplyr::recode(sub_data$Habitat, BF='Seasonally flooded', TF= 'Terra Firme')

TWI_plot <- sub_data %>%
mutate(Forest = fct_relevel(Forest, 
            "Bafog", "Paracou", "Kaw")) %>%
ggplot() +
aes(x = Forest, y = TWI, fill = Habitat) +
geom_boxplot() +
scale_fill_manual(
    values = c(`Seasonally flooded` = "#56B4E9",
    `Terra Firme` = "#E79F02")
                  ) +
ylab("Topographic wetness index")+
theme_minimal()+
theme(text = element_text(size = 16))     

ggsave(filename = "TWI in habitats.png", plot = TWI_plot, bg = "white", width = 10, height = 8, dpi = 600)
```


## Exploring na

Exploring where Nas are located in the dataset and imputing traits except SD.

```{r exploring NA}

#check the nas
pMiss <- function(x){sum(is.na(x))/length(x)*100}
apply(Metradica,2,pMiss)

#we see that SD is almost 30% missing values, the rest is below a threshold of 5%
library(VIM)
aggr_plot <- aggr(Metradica, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(Metradica), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))

#imputing th emissing data for all traits 
library(mice)
tempData <- mice(Metradica,m=5,maxit=50,meth='pmm',seed=500)
summary(tempData)
completedData <- complete(tempData,1)

#no imputation of SD
data <- Metradica %>% dplyr::select(-SD)
tempData_noSD <- mice(data,m=5,maxit=50,meth='pmm',seed=500) #m=5 is 5 datasets
summary(tempData_noSD)
completedData <- complete(tempData_noSD,1) #1 is choosing dataset 1 out of the 5

B <- Metradica %>% dplyr::select(Code, SD)

A <- left_join(completedData, B,  c("Code"))

#write.csv(A, "Subset_imputation_exceptSD.csv", col.names = FALSE, row.names = FALSE)

#inspecting data after imputation
densityplot(tempData_noSD)
tempData_noSD$imp$K

```

## Field & trait info joined

```{r field information}
Data_subset_imputed <- read.csv("Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv")

#Bafog_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/information_sites_and_tree_individuals/FieldSheets/input/Metradica/input/Bafog/Bafog_individuals.csv") %>% 
#  # dplyr::select(Code, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins)
# 
# Kaw_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/information_sites_and_tree_individuals/FieldSheets/input/Metradica/input/Kaw/Kaw_individuals.csv") %>%
#   dplyr::select(Code, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins)
# 
# Paracou_individuals <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/information_sites_and_tree_individuals/FieldSheets/input/Metradica/input/Paracou/Paracou.csv") %>%
#   dplyr::select(Code, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins)
# 
# individuals_FTH2021 <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/information_sites_and_tree_individuals/FieldSheets/input/Metradica/input/Paracou/individuals_FTH2021.csv") %>%
#   dplyr::select(Code, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins)
#c <- rbind(Paracou_individuals, Bafog_individuals, Kaw_individuals, individuals_FTH2021)

Fieldsheet_info <- read.csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/Trait_Data_Cleaning/information_sites_and_tree_individuals/FieldSheets/input/Metradica/output/Metradica_all_fieldsheet.csv") %>%
   dplyr::select(Code, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins, CrownPosition)




#adding Dawkins & height (tree + branch)

D <- Data_subset_imputed %>% left_join(Fieldsheet_info, by = "Code")

D %>% group_by(TreeDawkins, BranchDawkins) %>% tally()
D %>% group_by(BranchDawkins) %>% tally()
D$Name[which(D$TreeDawkins == 1)]
```

##trait imputation for all traits except Stomata

Guillaume Delahaye. 
Dans un milieu contraint (zone sèche, zone TF), on s'attend a avoir une meilleure coordination des traits. Donc un range de valeurs propre (Dim8-Dim1) plus etroit pour les especes spécialistes de TF. 



###PCA without stomata
```{r}
Data <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv") %>% 
  dplyr::select(-Code, -Genus, -Species, Habitat, Type, -SD) %>%
  rename(Potassium = K, 
         Phosphorous = P, 
         Nitrogen = N,
         Carbon = C) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "Nitrogen", "Carbon", "Phosphorous", "Potassium"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "Nitrogen", "Carbon", "Phosphorous", "Potassium"), log) %>% 
  mutate(TLP = -TLP)

Data$Type <- dplyr::recode(Data$Type, BF='SF Specialist', TF= 'TF Specialist')
#data <- mutate(data, Type = recode(Type, "BF" = "SF specialist")) #other way to do it

Data <- Data %>% na.omit()

g <- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Potassium + Phosphorous + Carbon + Nitrogen, data = Data, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data, colour = "Type", alpha = 0.4, size = 2, shape = "Type",
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         #loadings.label.hjust = c(0, -1,0, 0,0),
         #loadings.label.vjust = c(0, 0, 0, 0, 0),
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic(base_size = 22) +
 # scale_y_reverse() +
  scale_color_manual("Habitat\npreference", values = c("#009E72", "#56B4E9", "#E79F02")) +
  scale_shape_discrete("Habitat\npreference") +
  stat_ellipse(aes(col = Type), level = 0.85, size = 1.5)+
    theme(legend.position = c(0.85,0.2))

ggsave(filename = "PCA_full_HabitatPref_imputed.png", plot = g, bg = "white", width = 8, height = 8, dpi = 600)



#get contribution of trait in the different dimensions

res.pca <- PCA(Data %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
# Eigenvalues
eig.val <- get_eigenvalue(res.pca)
eig.val
fviz_eig(res.pca, addlabels = TRUE, ylim = c(0, 50))

# Contributions of variables to PC1
axe1 <- fviz_contrib(res.pca, choice = "var", axes = 1, top = 10)
ggsave(filename = "PCAaxe1.png", plot = axe1, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC2
axe2 <- fviz_contrib(res.pca, choice = "var", axes = 2, top = 10)
ggsave(filename = "PCAaxe2.png", plot = axe2, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC3
axe3 <- fviz_contrib(res.pca, choice = "var", axes = 3, top = 10)
ggsave(filename = "PCAaxe3.png", plot = axe3, bg = "white", width = 8, height = 8, dpi = 600)

# Contributions of variables to PC4
axe4 <- fviz_contrib(res.pca, choice = "var", axes = 4, top = 10)
ggsave(filename = "PCAaxe4.png", plot = axe4, bg = "white", width = 8, height = 8, dpi = 600)

#arrange into one figure
axes_constribution <- ggpubr::ggarrange(
  axe1,
  axe2,
  axe3,
  axe4,
  labels = c("A", "B", "C"),
  common.legend = T,
  legend = 'none',
  nrow= 2, ncol=2)

#ggsave(filename = "axes_contribution.png", plot = axes_constribution, bg = "white", width = 10, height = 10, dpi = 600)
```

Generalist 

```{r}
Data_G <- Data %>% filter(Type == "Generalist")

generalist <- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Potassium + Phosphorous + Carbon + Nitrogen, data = Data_G, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_G, colour = "Type", alpha = 0.4, size = 2, shape = "Type",
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         #loadings.label.hjust = c(0, -1,0, 0,0),
         #loadings.label.vjust = c(0, 0, 0, 0, 0),
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
 # scale_y_reverse() +
  scale_color_manual("Habitat\npreference", values = c("#009E72", "#56B4E9", "#E79F02")) +
  scale_shape_discrete("Habitat\npreference") +
  stat_ellipse(aes(col = Type), level = 0.85, size = 1.5)+
    theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_g <- PCA(Data_G %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
res.pca$eig
range_G <- res.pca$eig[1,1] - res.pca$eig[8,1]
sd_G <- sd(res.pca_g$eig[,1])
fviz_eig(res.pca_g, addlabels = TRUE, ylim = c(0, 50))

# Contributions of variables to PC1
axe1_g <- fviz_contrib(res.pca_g, choice = "var", axes = 1, top = 10)
#ggsave(filename = "PCAaxe1.png", plot = axe1, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC2
axe2_g <- fviz_contrib(res.pca_g, choice = "var", axes = 2, top = 10)
#ggsave(filename = "PCAaxe2.png", plot = axe2, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC3
axe3_g <- fviz_contrib(res.pca_g, choice = "var", axes = 3, top = 10)
#ggsave(filename = "PCAaxe3.png", plot = axe3, bg = "white", width = 8, height = 8, dpi = 600)

# Contributions of variables to PC4
# axe4 <- fviz_contrib(res.pca, choice = "var", axes = 4, top = 10)
# ggsave(filename = "PCAaxe4.png", plot = axe4, bg = "white", width = 8, height = 8, dpi = 600)

#arrange into one figure
axes_constribution_generalist <- ggpubr::ggarrange(
  generalist,
  axe1_g,
  axe2_g,
  axe3_g,
  labels = c("A", "B", "C", "D"),
  common.legend = T,
  legend = 'none',
  nrow= 2, ncol=2)
```

TF specialist

```{r}
Data_TF <- Data %>% filter(Type == "TF Specialist")

specialist_TF <- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Potassium + Phosphorous + Carbon + Nitrogen, data = Data_TF, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_TF, colour = "Type", alpha = 0.4, size = 2, shape = "Type",
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         #loadings.label.hjust = c(0, -1,0, 0,0),
         #loadings.label.vjust = c(0, 0, 0, 0, 0),
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
 # scale_y_reverse() +
  scale_color_manual("Habitat\npreference", values = c("#E79F02")) +
  scale_shape_discrete("Habitat\npreference") +
  stat_ellipse(aes(col = Type), level = 0.85, size = 1.5)+
    theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_tf <- PCA(Data_TF %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
res.pca_tf$eig
range_tf <- res.pca_tf$eig[1,1] - res.pca_tf$eig[8,1]
sd_tf <- sd(res.pca_tf$eig[,1])
fviz_eig(res.pca_tf, addlabels = TRUE, ylim = c(0, 50))

# Contributions of variables to PC1
axe1_tf <- fviz_contrib(res.pca_tf, choice = "var", axes = 1, top = 10)
#ggsave(filename = "PCAaxe1.png", plot = axe1, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC2
axe2_tf <- fviz_contrib(res.pca_tf, choice = "var", axes = 2, top = 10)
#ggsave(filename = "PCAaxe2.png", plot = axe2, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC3
axe3_tf <- fviz_contrib(res.pca_tf, choice = "var", axes = 3, top = 10)
#ggsave(filename = "PCAaxe3.png", plot = axe3, bg = "white", width = 8, height = 8, dpi = 600)

# Contributions of variables to PC4
# axe4 <- fviz_contrib(res.pca, choice = "var", axes = 4, top = 10)
# ggsave(filename = "PCAaxe4.png", plot = axe4, bg = "white", width = 8, height = 8, dpi = 600)

#arrange into one figure
axes_constribution_TF <- ggpubr::ggarrange(
  specialist_TF,
  axe1_tf,
  axe2_tf,
  axe3_tf,
  labels = c("A", "B", "C", "D"),
  common.legend = T,
  legend = 'none',
  nrow= 2, ncol=2)
```

SF specialist
```{r}
Data_SF <- Data %>% filter(Type == "SF Specialist")

specialist_SF <- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Potassium + Phosphorous + Carbon + Nitrogen, data = Data_SF, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_SF, colour = "Type", alpha = 0.4, size = 2, shape = "Type",
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         #loadings.label.hjust = c(0, -1,0, 0,0),
         #loadings.label.vjust = c(0, 0, 0, 0, 0),
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
 # scale_y_reverse() +
  scale_color_manual("Habitat\npreference", values = c("#56B4E9")) +
  scale_shape_discrete("Habitat\npreference") +
  stat_ellipse(aes(col = Type), level = 0.85, size = 1.5)+
    theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_sf <- PCA(Data_SF %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)

res.pca_sf$eig
range_sf <- res.pca_sf$eig[1,1] - res.pca_sf$eig[8,1]
sd_sf <- sd(res.pca_sf$eig[,1])
fviz_eig(res.pca_sf, addlabels = TRUE, ylim = c(0, 50))

# Contributions of variables to PC1
axe1_sf <- fviz_contrib(res.pca_sf, choice = "var", axes = 1, top = 10)
#ggsave(filename = "PCAaxe1.png", plot = axe1, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC2
axe2_sf <- fviz_contrib(res.pca_sf, choice = "var", axes = 2, top = 10)
#ggsave(filename = "PCAaxe2.png", plot = axe2, bg = "white", width = 8, height = 8, dpi = 600)
# Contributions of variables to PC3
axe3_sf <- fviz_contrib(res.pca_sf, choice = "var", axes = 3, top = 10)
#ggsave(filename = "PCAaxe3.png", plot = axe3, bg = "white", width = 8, height = 8, dpi = 600)

# Contributions of variables to PC4
# axe4 <- fviz_contrib(res.pca, choice = "var", axes = 4, top = 10)
# ggsave(filename = "PCAaxe4.png", plot = axe4, bg = "white", width = 8, height = 8, dpi = 600)

#arrange into one figure
axes_constribution_SF <- ggpubr::ggarrange(
  specialist_SF,
  axe1_sf,
  axe2_sf,
  axe3_sf,
  labels = c("A", "B", "C", "D"),
  common.legend = T,
  legend = 'none',
  nrow= 2, ncol=2)
```

Importance d'une analyse multivariée que trait par trait, surtout à l'echelle de la communauté. 
Simplifier les interpretations à un trait ne fonctionne plus. 
Chercher des traits non corrélés et sur les différents axes (LES, fine root, wood, DIY, etc...)

##BF/TF

```{r}
Data_G_BF_collect <- Data %>% filter(Type == "Generalist") %>% filter(Habitat== "BF")

generalist_SF <- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Potassium + Phosphorous + Carbon + Nitrogen, data = Data_G_BF_collect, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_G_BF_collect, colour = "Type", alpha = 0.4, size = 2, shape = "Type",
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         #loadings.label.hjust = c(0, -1,0, 0,0),
         #loadings.label.vjust = c(0, 0, 0, 0, 0),
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
 # scale_y_reverse() +
  scale_color_manual("Habitat\ncollect", values = c("#56B4E9")) +
  scale_shape_discrete("Habitat\ncollect") +
  stat_ellipse(aes(col = Type), level = 0.85, size = 1.5)+
    theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_G_sf <- PCA(Data_G_BF_collect %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)

res.pca_G_sf$eig
range_G_sf <- res.pca_G_sf$eig[1,1] - res.pca_G_sf$eig[8,1]
sd_G_sf <- sd(res.pca_G_sf$eig[,1])
fviz_eig(res.pca_G_sf, addlabels = TRUE, ylim = c(0, 50))

```


#standardization of ITI

creation d'un jeu de donnée virtuel pour chaque pref d'habitat.

```{generalist r}
#generalist
generalist <- c()
generalist_sd <- c()
species_rich_G <- length(levels(as.factor(Data_G$Name)))
species_rich_total <- length(levels(as.factor(Data$Name)))
for (i in 1:1000){ #i eme communauté
  
  species_list <- sample(levels(as.factor(Data$Name)), size = species_rich_G, replace =FALSE)
  
  #maintient abondance 
Data_G_abon <- c()

for (s in 1:species_rich_G){
  for (j in 1:summary(as.factor(Data_G$Name))[s]){
    
      Data_G_abon <- rbind(Data_G_abon, 
                           Data[sample(which(Data$Name == species_list[s]), 1),]) #standardize effect size, pour preserver la strcture du jeu de données initial. indv tirer au hazard. maintient de richesse specifique d'une commuanté (habitat pref) à l'autre 
    
  }
  
  }  
  
  PCA_comm_G <- PCA(Data_G_abon %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
  
generalist <- c(generalist, PCA_comm_G$eig[1,1] - PCA_comm_G$eig[8,1] )
generalist_sd <- c(generalist_sd , sd(PCA_comm_G$eig[,1]))


}

plot_G <- hist(generalist)

ITI_G <- (range_G - mean(generalist))/sd(generalist)
ITI_G_sd <- (sd_G - mean(generalist_sd))/sd(generalist_sd)

# Basic density
library(ggplot2)
plot_G <- ggplot(as.data.frame(generalist), aes(x=generalist))+
  geom_density()+
  theme_minimal()

# Add mean line
plot_G <- plot_G + geom_vline(aes(xintercept=range_G),
            color="green", linetype="dashed", size=1)

#add 0.05 cut off
cutoff <- quantile(generalist, probs = 0.05)

plot_G <- plot_G + geom_vline(aes(xintercept=cutoff),
            color="red", size=0.5)
```

```{generalist sf r}
#generalist SF

generalist_sf <- c()
generalist_sf_sd <- c()
species_rich_G_sf <- length(levels(as.factor(Data_G_BF_collect$Name)))
species_rich_total <- length(levels(as.factor(Data$Name)))
for (i in 1:1000){ #i eme communauté
  
  species_list <- sample(levels(as.factor(Data$Name)), size = species_rich_G_sf, replace =FALSE)
  
  #maintient abondance 
Data_G_abon_sf <- c()

for (s in 1:species_rich_G_sf){
  for (j in 1:summary(as.factor(Data_G_BF_collect$Name))[s]){
    
      Data_G_abon <- rbind(Data_G_abon_sf, 
                           Data[sample(which(Data$Name == species_list[s]), 1),]) #standardize effect size, pour preserver la strcture du jeu de données initial. indv tirer au hazard. maintient de richesse specifique d'une commuanté (habitat pref) à l'autre 
    
  }
  
  }  
  
  PCA_comm_G_sf <- PCA(Data_G_abon_sf %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
  
generalist_sf <- c(generalist_sf, PCA_comm_G_sf$eig[1,1] - PCA_comm_G_sf$eig[8,1] )
generalist_sf_sd <- c(generalist_sf_sd , sd(PCA_comm_G_sf$eig[,1]))


}

ITI_G_sf <- (range_G_sf - mean(generalist_sf))/sd(generalist_sf)
ITI_G_sf_sd <- (sd_G_sf - mean(generalist_sf_sd))/sd(generalist_sf_sd)

# Basic density
plot_G_sf <- ggplot(as.data.frame(generalist_sf), aes(x=generalist_sf))+
  geom_density()+
  theme_minimal()

# Add mean line
plot_G_sf <- plot_G_sf + geom_vline(aes(xintercept=ITI_G_sf),
            color="green", linetype="dashed", size=1)
```



boottrap, tirage avec remise, mettre replace = TRUE

modele null commun a tous les groups
bootstrop par pref d'habtiat et comparaisons des trois distributions 

```{specialist tf r}
#specialist tf
specialist_tf <- c()
specialist_tf_sd <- c()
species_rich_tf <- length(levels(as.factor(Data_TF$Name)))
species_rich_total <- length(levels(as.factor(Data$Name)))
for (i in 1:1000){ #i eme communauté
  
  species_list <- sample(levels(as.factor(Data$Name)), size = species_rich_tf, replace =FALSE)
  
  #maintient abondance 
Data_tf_abon <- c()

for (s in 1:species_rich_tf){
  for (j in 1:summary(as.factor(Data_TF$Name))[s]){
    
      Data_tf_abon <- rbind(Data_tf_abon, 
                           Data[sample(which(Data$Name == species_list[s]), 1),])
    
  }
  
  }  
  
  PCA_comm_tf <- PCA(Data_tf_abon %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
  
specialist_tf <- c(specialist_tf, PCA_comm_tf$eig[1,1] - PCA_comm_tf$eig[8,1] )
specialist_tf_sd <- c(specialist_tf_sd, sd(PCA_comm_tf$eig[,1]))
}

ITI_tf <- (range_tf - mean(specialist_tf))/sd(specialist_tf)
ITI_tf_sd <- (sd_tf - mean(specialist_tf_sd))/sd(specialist_tf_sd)


# Basic density
plot_TF <- ggplot(as.data.frame(specialist_tf), aes(x=specialist_tf))+
  geom_density()+
  theme_minimal()

# Add mean line
plot_TF <- plot_TF + geom_vline(aes(xintercept=range_tf),
            color="orange", linetype="dashed", size=1)
#add 0.05 cut off
cutoff_TF <- quantile(specialist_tf, probs = 0.05)

plot_TF <- plot_TF + geom_vline(aes(xintercept=cutoff_TF),
            color="red", size=0.5)

```

```{specialist sf r}
#specialist sf
specialist_sf <- c()
specialist_sf_sd <- c()

species_rich_sf <- length(levels(as.factor(Data_SF$Name)))
species_rich_total <- length(levels(as.factor(Data$Name)))
for (i in 1:1000){ #i eme communauté
  
  species_list <- sample(levels(as.factor(Data$Name)), size = species_rich_sf, replace =FALSE)
  
  #maintient abondance 
Data_sf_abon <- c()

for (s in 1:species_rich_sf){
  for (j in 1:summary(as.factor(Data_SF$Name))[s]){
    
      Data_sf_abon <- rbind(Data_sf_abon, 
                           Data[sample(which(Data$Name == species_list[s]), 1),])
    
  }
  
  }  
  
  PCA_comm_sf <- PCA(Data_sf_abon %>% dplyr::select(-Plot, -Forest, -Name, -Type, -Habitat, -TWI, -DBH), graph = FALSE)
  
specialist_sf <- c(specialist_sf, PCA_comm_sf$eig[1,1] - PCA_comm_sf$eig[8,1] )
specialist_sf_sd <- c(specialist_sf_sd, sd(PCA_comm_sf$eig[,1]))
}
                      
ITI_sf <- (range_sf - mean(specialist_sf))/sd(specialist_sf)
ITI_sf_sd <- (sd_sf - mean(specialist_sf_sd))/sd(specialist_sf_sd)


# Basic density
plot_SF <- ggplot(as.data.frame(specialist_sf), aes(x=specialist_sf))+
  geom_density()+
  theme_minimal()

# Add mean line
plot_SF <- plot_SF + geom_vline(aes(xintercept=range_sf),
            color="blue", linetype="dashed", size=1)

cutoff_SF <- quantile(specialist_sf, probs = 0.95)

plot_SF <- plot_SF + geom_vline(aes(xintercept=cutoff_SF),
            color="red", size=0.5)
```

```{figure preference ITI r}
fig <- ggpubr::ggarrange(
  plot_G,
  plot_SF,
  plot_TF, 
  labels = c("A", "B", "C"),
  nrow= 3, ncol=1)

fig
```
#### classes de TWI

```{r}
nb_class <- 8
class_size <- (max(Metradica_log$TWI)-min(Metradica_log$TWI))/nb_class



data <- as.data.frame(seq(1:nb_class))

colnames(data)[1] <- "class"

data$min <- c()
data$max <- c()
data$mean <- c()
Metradica_log$class_TWI <- as.numeric(NA)


for (i in 1:nb_class){
  
  data$min[i] <- min(Metradica_log$TWI) + (i-1) * class_size
  data$max[i] <- min(Metradica_log$TWI) +i * class_size
  data$mean[i] <- (data$max[i] + data$min[i])/2
  
  Metradica_log$class_TWI[which(Metradica_log$TWI <= data$max[i] & Metradica_log$TWI > data$min[i]) ] <- i
                                           
  
}

Metradica_log$class_TWI[which(Metradica_log$TWI == data$min[1])]  <- 1

data

table(Metradica_log$class_TWI)
table(is.na(Metradica_log$class_TWI))

```
## classe TWI bis 
```{r}
#data used (log on all traits)
Metradica_log <- read.csv("Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv") %>% 
  rename(Potassium = K, 
         Phosphorous = P, 
         Nitrogen = N,
         Carbon = C) %>% 
  relocate(SD, .after = MajVLA) %>%
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD", "Phosphorous","Carbon", "Nitrogen", "Potassium", "TWI"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD", "Phosphorous","Carbon", "Nitrogen", "Potassium", "TWI"), log) %>% 
  mutate(TLP = -TLP) 

nb_class <- 8
class_size <- (max(Metradica_log$TWI)-min(Metradica_log$TWI))/nb_class



data <- as.data.frame(seq(1:nb_class))

colnames(data)[1] <- "class"

data$min <- c()
data$max <- c()
data$mean <- c()
Metradica_log$class_TWI <- as.numeric(NA)


for (i in 1:nb_class){
  
  data$min[i] <- min(Metradica_log$TWI) + (i-1) * class_size
  data$max[i] <- min(Metradica_log$TWI) +i * class_size
  data$mean[i] <- (data$max[i] + data$min[i])/2
  
  Metradica_log$class_TWI[which(Metradica_log$TWI <= data$max[i] & Metradica_log$TWI > data$min[i]) ] <- i
                                           
  
}

Metradica_log$class_TWI[which(Metradica_log$TWI == data$min[1])]  <- 1

#merge class 6,7 and 8 together 
Metradica_log$class_TWI[which(Metradica_log$class_TWI == 7)]  <- 6
Metradica_log$class_TWI[which(Metradica_log$class_TWI == 8)]  <- 6


data

table(Metradica_log$class_TWI)
table(is.na(Metradica_log$class_TWI))

####################################################
#Construction of the 6 PCAs for each TWI class level
####################################################
#1------------
Data_1 <- Metradica_log %>% filter(class_TWI == 1)

TWI_class_1<- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Phosphorous + Potassium + Carbon + Nitrogen, data = Data_1, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_1, alpha = 0.4, size = 2,
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
  theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_1 <- PCA(Data_1 %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
res.pca_1$eig
range_1 <- res.pca_1$eig[1,1] - res.pca_1$eig[8,1]
sd_1 <- sd(res.pca_1$eig[,1])
fviz_eig(res.pca_1, addlabels = TRUE, ylim = c(0, 50))

#calcul de la communauté nulle associée

class_1 <- c()
class_1_sd <- c()
indv_rich_1 <- length(levels(as.factor(Data_1$Code)))
indv_rich_total <- length(levels(as.factor(Metradica_log$Code)))
for (i in 1:1000){ #i eme communauté
  
  indv_list <- sample(levels(as.factor(Metradica_log$Code)), size = indv_rich_1, replace =FALSE)
  
  #maintient abondance 
Data_1_abon <- c()

for (s in 1:indv_rich_1){
  for (j in 1:summary(as.factor(Data_1$Code))[s]){
    
      Data_1_abon <- rbind(Data_1_abon, 
                           Metradica_log[sample(which(Metradica_log$Code == indv_list[s]), 1),]) #standardize effect size, pour preserver la strcture du jeu de données initial. indv tirer au hazard.
    
  }
  
  }  
  
  PCA_comm_1 <- PCA(Data_1_abon %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
  
class_1 <- c(class_1, PCA_comm_1$eig[1,1] - PCA_comm_1$eig[8,1] )
class_1_sd <- c(class_1_sd , sd(PCA_comm_1$eig[,1]))


}

plot_1 <- hist(class_1)

ITI_1 <- (range_1 - mean(class_1))/sd(class_1_sd)
ITI_1_sd <- (sd_1 - mean(class_1_sd))/sd(class_1_sd)

#2--------------------------
Data_2 <- Metradica_log %>% filter(class_TWI == 2)

TWI_class_2<- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Phosphorous + Potassium + Carbon + Nitrogen, data = Data_2, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_2, alpha = 0.4, size = 2,
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
  theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_2 <- PCA(Data_2 %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
res.pca_2$eig
range_2 <- res.pca_2$eig[1,1] - res.pca_2$eig[8,1]
sd_2 <- sd(res.pca_2$eig[,1])
fviz_eig(res.pca_2, addlabels = TRUE, ylim = c(0, 50))
#calcul de la communauté nulle associée

class_2 <- c()
class_2_sd <- c()
indv_rich_2 <- length(levels(as.factor(Data_2$Code)))
indv_rich_total <- length(levels(as.factor(Metradica_log$Code)))
for (i in 1:3){ #i eme communauté
  
  indv_list <- sample(levels(as.factor(Metradica_log$Code)), size = indv_rich_2, replace =FALSE)
  
  #maintient abondance 
Data_2_abon <- data.frame()

for (s in 1:indv_rich_2){
  for (j in 1:111){
    
      Data_2_abon <- rbind(Data_2_abon, 
                           Metradica_log[sample(which(Metradica_log$Code == indv_list[s]), 1),]) #standardize effect size, pour preserver la strcture du jeu de données initial. indv tirer au hazard. on construit Data_2_abond en tirant au hasard dans le grand dataset complet des individus correspondant aux individus dans la liste indv_list qui a la taille du jeu de données de la classe de TWI (ici 2)
    
  }
  
  }  
  
  PCA_comm_2 <- PCA(Data_2_abon %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
  
class_2 <- c(class_2, PCA_comm_2$eig[1,1] - PCA_comm_2$eig[8,1] )
class_2_sd <- c(class_2_sd , sd(PCA_comm_2$eig[,1]))


}

plot_2 <- hist(class_2)

ITI_2 <- (range_2 - mean(class_2))/sd(class_2_sd)
ITI_2_sd <- (sd_2 - mean(class_2_sd))/sd(class_2_sd)


#3--------------
Data_3 <- Metradica_log %>% filter(class_TWI == 3)

TWI_class_3<- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Phosphorous + Potassium + Carbon + Nitrogen, data = Data_3, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_3, alpha = 0.4, size = 2,
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
  theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_3 <- PCA(Data_3 %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
res.pca_3$eig
range_3 <- res.pca_3$eig[1,1] - res.pca_3$eig[8,1]
sd_3 <- sd(res.pca_3$eig[,1])
fviz_eig(res.pca_3, addlabels = TRUE, ylim = c(0, 50))

#calcul de la communauté nulle associée

class_3 <- c()
class_3_sd <- c()
indv_rich_3 <- length(levels(as.factor(Data_3$Code)))
indv_rich_total <- length(levels(as.factor(Metradica_log$Code)))
for (i in 1:1000){ #i eme communauté
  
  indv_list <- sample(levels(as.factor(Metradica_log$Code)), size = indv_rich_3, replace =FALSE)
  
  #maintient abondance 
Data_3_abon <- c()

for (s in 1:indv_rich_3){
  for (j in 1:summary(as.factor(Data_3$Code))[s]){
    
      Data_3_abon <- rbind(Data_3_abon, 
                           Metradica_log[sample(which(Metradica_log$Code == indv_list[s]), 1),]) #standardize effect size, pour preserver la strcture du jeu de données initial. indv tirer au hazard.
    
  }
  
  }  
  
  PCA_comm_3 <- PCA(Data_3_abon %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
  
class_3 <- c(class_3, PCA_comm_3$eig[1,1] - PCA_comm_3$eig[8,1] )
class_3_sd <- c(class_3_sd , sd(PCA_comm_3$eig[,1]))


}

plot_3 <- hist(class_3)

ITI_3 <- (range_3 - mean(class_3))/sd(class_3_sd)
ITI_3_sd <- (sd_3 - mean(class_3_sd))/sd(class_3_sd)

#4------------
Data_4 <- Metradica_log %>% filter(class_TWI == 4)

TWI_class_4<- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Phosphorous + Potassium + Carbon + Nitrogen, data = Data_4, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_4, alpha = 0.4, size = 2,
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
  theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_4 <- PCA(Data_4 %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
res.pca_4$eig
range_4 <- res.pca_4$eig[1,1] - res.pca_4$eig[8,1]
sd_4 <- sd(res.pca_4$eig[,1])
fviz_eig(res.pca_4, addlabels = TRUE, ylim = c(0, 50))

#5----------
Data_5 <- Metradica_log %>% filter(class_TWI == 5)

TWI_class_5<- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Phosphorous + Potassium + Carbon + Nitrogen, data = Data_5, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_5, alpha = 0.4, size = 2,
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
  theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_5 <- PCA(Data_5 %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
res.pca_5$eig
range_5 <- res.pca_5$eig[1,1] - res.pca_5$eig[8,1]
sd_5 <- sd(res.pca_5$eig[,1])
fviz_eig(res.pca_5, addlabels = TRUE, ylim = c(0, 50))

#6----------------
Data_6 <- Metradica_log %>% filter(class_TWI == 6)

TWI_class_6<- autoplot(princomp(~ Gmin + TLP + LSWC + MajVLA + Phosphorous + Potassium + Carbon + Nitrogen, data = Data_6, cor = T), #  If TRUE, the data will be centered and scaled before the analysis. Standardization typically means rescale data to have a mean of 0 and a standard deviation of 1 (unit variance). it computes a correlation matrix
         data = Data_6, alpha = 0.4, size = 2,
         loadings = T, loadings.label = T, loadings.label.repel = T, 
         loadings.label.colour = 'black', loadings.colour = 'black',
         loadings.label.size = 6) +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme_classic() +
  theme(legend.position = c(0.85,0.2))

#get contribution of trait in the different dimensions

res.pca_6 <- PCA(Data_6 %>% dplyr::select(-Plot, -Forest,-Genus, -Species, -Name, -Type, -Habitat, -TWI, -DBH, -SD), graph = FALSE)
res.pca_6$eig
range_6 <- res.pca_6$eig[1,1] - res.pca_6$eig[8,1]
sd_6 <- sd(res.pca_6$eig[,1])
fviz_eig(res.pca_6, addlabels = TRUE, ylim = c(0, 50))
```

### Permanova

To explore differences along each PC axis. Fortunel, C., Stahl, C., Heuret, P., Nicolini, E. & Baraloto, C. (2020). Disentangling the effects of environment and ontogeny on tree functional dimensions for congeneric species in tropical forests. New Phytol., 226, 385–395.

* The dependent variables should be normally distribute within groups.
  + yes but except for nitrogen
```{r}
Data %>%
ggplot() +
 aes(x = Nitrogen) + #already log
 geom_histogram(bins = 30L, fill = "#112446") +
 xlab("Nitrogen")+
 theme_minimal()
```

* Homogeneity of variances across the range of predictors.Levene's and Barlett's test.
  + Bartlett’s test: Compare the variances of two or more groups. The data must be normally distributed.
  
```{r}
count <- 5
list <- list()

for (i in Data[,6:13]){
  count <- count + 1
  name <- names(Data[,count])
  
  list[[name]] <- local({
   
    i <- i
  bartlett.test(i ~ Type, data = Data)
  
  })
  
}

print(list)
#The critical value of chi square is 9.488. If the Bartlett test statistic is greater than this critical value, there is a significant difference in the variances. If the Bartlett test statistic is less than this critical value, there is not a significance difference.

# p-values less than 0.05 suggest variances are significantly different and the homogeneity of variance assumption has been violated, which is the case for all except Gmin, phosphorous, and Potassium. 
```

  + Levene’s test: A robust alternative to the Bartlett’s test that is less sensitive to departures from normality.

* Linearity between all pairs of dependent variables, all pairs of covariates, and all dependent variable-covariate pairs in each cell

PERMANOVA, (permutational multivariate ANOVA), is a non-parametric alternative to MANOVA, or multivariate ANOVA test. It is appropriate with multiple sets of variables that do not meet the assumptions of MANOVA, namely multivariate normality.

Null hypothesis: Groups do not differ/ are equivalent in spread or position multivariate space.

After having computed an ordination such as PCA, it shows that habitat preferences do overlap. I want to know if the trait assemblage is different between the 3 habtiat preferences. A PERMANOVA lets me statistically determine if the centroid of the cluster of samples for the generalist differ from the centroid of samples for the specialist TF and specalist SF. Note that PERMANOVA is not done on the output of a ordination technique but rather on the underlying distance matrices. 

The test statistic is a pseudo F-ratio, similar to the F-ratio in ANOVA. It compares the total sum of squared dissimilarities (or ranked dissimilarities) among objects belonging to different groups to that of objects belonging to the same group. Larger F-ratios indicate more pronounced group seperation, however, the significance of this ratiio is usually of more interest than its magnitude. (https://archetypalecology.wordpress.com/2018/02/21/permutational-multivariate-analysis-of-variance-permanova-in-r-preliminary/)


```{r}

data_PCA <- Data[, c(1:13)][,-c(1,2,3,4,5)]

res.PCA <- FactoMineR::PCA(data_PCA, quali.sup = 1, graph = F)

```


```{r}
dis <- vegdist(data_PCA,method="euclidean") #Dissimilarity Indices for Community Ecologists
#dis2 <- vegdist(data_PCA, method ="bray")
mod <- betadisper(dis,Data$Type)
anova(mod)
```
the null hypothesis of no differences between types is cannot be rejected (pvalue 0.3816)

H0 = means are not different

P-value = 0.3816 so we cannot reject H0 : our group dispersions are not different between types.

Check if our treatments have different means. Use a permuting method to check if the difference is really due to the treatments.

```{r}
a<-adonis2(data_PCA~Data$Type, permutations = 999, method = "euclidean") 

permanova <-a %>%
  kbl(caption="Permutational Multivariate Analysis of Variance (PERMANOVA)", digits = 3, booktabs=TRUE) %>% 
  kable_styling(latex_options="scale_down", full_width = FALSE) %>%
 kable_classic(full_width = F, html_font = "Cambria") #%>%
  #save_kable(file = "Permanova.png")


```

P-value (0.001) *** is significant so our group types have different means.

Process a pairwise analyse to detect which treatments are different from each other.

install pairwise : ` install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")`

```{r}
library(pairwiseAdonis)
pairwise_adonis_type <- pairwise.adonis(data_PCA,Data$Type, sim.method = "euclidean")

pairwise_adonis_type$pairs[1] <- "TF specialist vs SF specialist"
pairwise_adonis_type$pairs[2] <- "TF specialist vs generalist"
pairwise_adonis_type$pairs[3] <- "SF specialist vs generalist"

pairwise_adonis_habitat <- pairwise.adonis(data_PCA,Data$Habitat, sim.method = "euclidean") 

pairwise_adonis_habitat$pairs[1] <- "TF habitat vs SF habitat"


pairwise_adonis_type_table <- pairwise_adonis_type %>%
  relocate(pairs, .after = sig) %>%
  kbl(caption = "A. Species' preferences",digits =3) %>% 
  kable_classic(full_width = F, html_font = "Cambria") %>%
  save_kable(file = "A. Species' preferences.png", zoom = 5)


pairwise_adonis_habitat_table <- pairwise_adonis_habitat %>%
  relocate(pairs, .after = sig) %>%
  kbl(caption = "B. Habitat of collect",digits =3) %>% 
  kable_classic(full_width = F, html_font = "Cambria") %>%
  save_kable(file = "B. Habitat of collect.png", zoom = 5)

```
In order to reject the null hypothesis that the group means are equal, we need pvalue < 0.05 and a high F-value. We use the F-value to determine whether the between group variability of means is larger than the within the group variability of the individual values. If the ratio of between group and within group variation is sufficiently large, you can conclude that not all the means are equal.

If the variation between the sample means is high relative to the variation within each of the samples, then the F-value will be large.

```{r}
tt1 <- ttheme_default()
tt2 <- ttheme_minimal()

grid.arrange(
  tableGrob(permanova, theme=tt1),
  tableGrob(pairwise_adonis, theme=tt2),
  nrow=1) %>%  
  kbl(caption = "Permutational MANOVA on habitat preference*") %>% 
  kable_classic(full_width = F, html_font = "Cambria") 
```

### Correlation

a table for pairwise trait correlation coefficient and significance?

No trait imputation for this section.
Log or not logged, correlations are going to be the same.

```{r}

library(corrplot)

traits <- Data %>% #already log
  rename(`  K` = Potassium, 
         `  P` = Phosphorous, 
         `  N` = Nitrogen,
         `  C` = Carbon,
         gmin = Gmin) %>% 
  dplyr::select(-Name, -Habitat, -Type, -Forest, -Plot, -TWI, -DBH) 

#to add significance
testRes = cor.mtest(traits, conf.level = 0.95)

#image output, have to run until last live dev.off() for it to work.
png(height=500, width=500, file="mycorr_noTWI_noSD_imputed.png", type = "cairo")

#create correlation matrix
cor_matrix <- traits %>%
  na.omit() %>%
  cor(method = "spearman")

#correlation plot with no rows and column labels and without colors in the diagonal
corrplot(cor_matrix, p.mat = testRes$p, method = 'circle',  #addCoef.col ='black', insig='blank',
         sig.level = 0.10, addrect = 2, diag = FALSE, tl.pos = FALSE)

# Add labels to the diagonal
text(rev(1:nrow(cor_matrix)), 1:nrow(cor_matrix), rev(colnames(cor_matrix)), 
     cex = 1.5, pos = 4, offset = -1.5, col= "red", ifelse(is.na(diag(cor_matrix)), NA, 1))

dev.off()

#significance
install.packages("Hmisc")
library("Hmisc")
res <- rcorr(as.matrix(traits), type = "spearman")
res
# Extract the correlation coefficients
library(kableExtra)
library(magick)

res$r %>%
  kbl(caption ="", digits =2)  %>%
  add_header_above(c("<span style='font-size: 20px; font-weight: bold;'>A. Pairwise table of the correlation coefficients</span>" = 9), escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Cambria")  %>%
  save_kable("corr_coef.png")
  
img <- image_read("corr_coef.png")
img_resized <- image_scale(img, "800x600")

# Save the resized image
image_write(img_resized, "corr_coef_resized.png")



# Extract p-values
res$P%>%
  kbl(caption ="", digits =3)  %>%
  add_header_above(c("<span style='font-size: 20px; font-weight: bold;'>B. Pairwise table of the associated p-values</span>" = 9), escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  save_kable("corr_pvalue.png")

img <- image_read("corr_pvalue.png")
img_resized <- image_scale(img, "800x600")

# Save the resized image
image_write(img_resized, "corr_pvalue_resized.png")


```


## Question 1
**Question (H1) Specialist species of contrasting habitats differ in trait values.**


$$ M0 : Y_{ik} = \mu + E_{ik}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) $$
$$ M1 : Y_{ik} = \mu + \alpha_i +  E_{ik}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) $$

Mais je veux prendre en compte que l'echantillonage a ete réalisé dans 3 forets qui chacune a les 2 habitats. je veux accepter les variations de mon site mais pas les etudier forcement.



$$ M2 : Y_{ijk} = \mu + \alpha_i +  \beta_j + \gamma_{ij} + E_{ijk}, \quad E_{ijk}\sim \mathcal{N} (0,\sigma^2) $$


Et prendre en compte que j'ai plein d'espèces differentes. 

Ces espèces ne sont pas très equilibrée en terme d'échantillonage. 


$$ M_{comp} : Y_{ijsk} = \mu + \alpha_i +  \beta_j + \gamma_{ij} +  A_{is} +  E_{ijsk}, \quad E_{ijsk}\sim \mathcal{N} (0,\sigma^2), \quad A_{is}\sim \mathcal{N} (0,\sigma^2_S),  $$


### Specialist data
```{r data specialist}

Metradica <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv") 

Metradica$Type <- as.factor(Metradica$Type)
Metradica$Name <- as.factor(Metradica$Name)
Metradica$Forest <- as.factor(Metradica$Forest)
data_specialist <- Metradica %>% filter(Type !="Generalist")


```

### gmin 
```{r H1 gmin}
# Global test
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_gmin <- lm(log(Gmin)~1, data= data_specialist)
gmin_habitat <- lm(log(Gmin) ~Type, data= data_specialist)
summary(gmin_habitat)
anova(M0_gmin,gmin_habitat) #2 objets : comparaisons de deux modeles. 
Anova(gmin_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


gmin_forest <- lm(log(Gmin) ~Type + Forest, data =  data_specialist)
anova(gmin_habitat, gmin_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(gmin_forest, gmin_habitat, type ="II") #symetrisation de l'habitat et de la forest. on regarde l'habitat sachant que forest est deja considere.

model_gmin <- lmer(log(Gmin) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_gmin)

#Check normality of residuals 

plot(model_gmin) #For the normality assumption to hold, the residuals should spread randomly around 0 and form a horizontal band.If the red trend line is approximately flat and close to zero, then one can assume that the residuals are normally distributed.

#pour lmer
str(model_gmin)
model_gmin #you access the lmer objects through@
resid(model_gmin)
hist(resid(model_gmin), main = "Residual Histogram")
boxplot(resid(model_gmin), main="Residual Box Plot")
qqnorm(resid(model_gmin)) 

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_gmin, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrats <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.448,"ns", "2")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

Gmin <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=Gmin, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(gmin~(mmol.m^-2~.s^-1))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(10), size= 6) +
  theme_minimal(base_size = 12) 
```
### TLP
```{r}
model_simple_tlp <- lm(log(-TLP) ~ 1, data=data_specialist)
model_habitat_tlp <-  lm(log(-TLP) ~ Type, data=data_specialist) 
anova(model_simple_tlp, model_habitat_tlp)
model_forest_tlp <- lm(log(-TLP) ~ Type + Forest, data=data_specialist) 
anova(model_habitat_tlp, model_forest_tlp)

#on explique tres peu avec l'habitat et avec la foret par rapport au model null.
model_TLP <- lmer(log(-TLP) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_TLP)

#Check normality of residuals 

plot(model_TLP) 

#pour lmer
hist(resid(model_TLP), main = "Residual Histogram")
qqnorm(resid(model_TLP))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_TLP, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame %>% mutate(responseCorr= -response, lower.CLCorr = -lower.CL, upper.CLCorr = -upper.CL)
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.772,"ns", "2")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#plot tlp


TLP <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=TLP, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(TLP~(MPa))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = responseCorr, 
                      ymin=lower.CLCorr, 
                      ymax= upper.CLCorr), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(-1.35), size= 6) +
  theme_minimal(base_size = 12) 
```

### LSWC 

```{r}
# Global test
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_LSWC <- lm(log(LSWC)~1, data= data_specialist)
LSWC_habitat <- lm(log(LSWC) ~Type, data= data_specialist)
summary(LSWC_habitat)
anova(M0_LSWC,LSWC_habitat) #2 objets : comparaisons de deux modeles. 
Anova(LSWC_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


LSWC_forest <- lm(log(LSWC) ~Type + Forest, data =  data_specialist)
anova(LSWC_habitat, LSWC_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(LSWC_forest, LSWC_habitat) #symetrisation de l'habitat et de la forest. on regarde l'habitat sachant que forest est deja considere.

model_LSWC <- lmer(log(LSWC) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_LSWC)

#Check normality of residuals
hist(resid(model_LSWC), main = "Residual Histogram")
qqnorm(resid(model_LSWC))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_LSWC, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.738,"ns", "150")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
LSWC <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=LSWC, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(LSWC~('%'))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(225), size= 6) +
  theme_minimal(base_size = 12) 
  
```

### MajVLA 

```{r}
# Global test
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_MajVLA <- lm(log(MajVLA)~1, data= data_specialist)
MajVLA_habitat <- lm(log(MajVLA) ~Type, data= data_specialist)
summary(MajVLA_habitat)
anova(M0_MajVLA,MajVLA_habitat) #2 objets : comparaisons de deux modeles. 
Anova(MajVLA_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


MajVLA_forest <- lm(log(MajVLA) ~Type + Forest, data =  data_specialist)
anova(MajVLA_habitat, MajVLA_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(MajVLA_forest, MajVLA_habitat) #symetrisation de l'habitat et de la forest. on regarde l'habitat sachant que forest est deja considere.

model_MajVLA <- lmer(log(MajVLA) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_MajVLA)

#Check normality of residuals
hist(resid(model_MajVLA), main = "Residual Histogram")
qqnorm(resid(model_MajVLA))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_MajVLA, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.762,"ns", "6")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
MajVLA <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=MajVLA, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(MajVLA~(mm.mm~.mm^-2))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(13), size= 6) +
  theme_minimal(base_size = 12) 
  
```


### K 

```{r}
# Global test
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_K <- lm(log(K)~1, data= data_specialist)
K_habitat <- lm(log(K) ~Type, data= data_specialist)
summary(K_habitat)
anova(M0_K,K_habitat) #2 objets : comparaisons de deux modeles. 
Anova(K_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


K_forest <- lm(log(K) ~Type + Forest, data =  data_specialist)
anova(K_habitat, K_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(K_forest, K_habitat) #gros effet foret ici

model_K <- lmer(log(K) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_K)

#Check normality of residuals
hist(resid(model_K), main = "Residual Histogram")
qqnorm(resid(model_K))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_K, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.099,"ns", "9")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
K <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=K, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(K~(g%.%kg^{-1}))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(17), size= 6) +
  theme_minimal(base_size = 12) 

```

### P 

```{r}
# Global test
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_P <- lm(log(P)~1, data= data_specialist)
P_habitat <- lm(log(P) ~Type, data= data_specialist)
summary(P_habitat)
anova(M0_P,P_habitat) #2 objets : comparaisons de deux modeles. 
Anova(P_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


P_forest <- lm(log(P) ~Type + Forest, data =  data_specialist)
anova(P_habitat, P_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(P_forest, P_habitat) #gros effet foret ici

model_P <- lmer(log(P) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_P)

#ChecP normality of residuals
hist(resid(model_P), main = "Residual Histogram")
qqnorm(resid(model_P))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_P, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tuPey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.0942,"ns", "9")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
P <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=P, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(P~(g%.%kg^{-1}))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(1.5), size= 6) +
  theme_minimal(base_size = 12) 
P
```

### C 

```{r}
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_C <- lm(log(C)~1, data= data_specialist)
C_habitat <- lm(log(C) ~Type, data= data_specialist)
summary(C_habitat)
anova(M0_C,C_habitat) #2 objets : comparaisons de deux modeles. 
Anova(C_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


C_forest <- lm(log(C) ~Type + Forest, data =  data_specialist)
anova(C_habitat, C_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(C_forest, C_habitat) #symetrisation de l'habitat et de la forest. on regarde l'habitat sachant que forest est deja considere.

model_C <- lmer(log(C) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_C)

#Check normality of residuals
hist(resid(model_C), main = "Residual Histogram")
qqnorm(resid(model_C))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_C, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.86,"ns", "52")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
C <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=C, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(C~('%'))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(56), size= 6) +
  theme_minimal(base_size = 12) 
```

### N 

```{r}
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_N <- lm(log(N)~1, data= data_specialist)
N_habitat <- lm(log(N) ~Type, data= data_specialist)
summary(N_habitat)
anova(M0_N,N_habitat) #2 objets : comparaisons de deux modeles. 
Anova(N_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


N_forest <- lm(log(N) ~Type + Forest, data =  data_specialist)
anova(N_habitat, N_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(N_forest, N_habitat) #symetrisation de l'habitat et de la forest. on regarde l'habitat sachant que forest est deja considere.

model_N <- lmer(log(N) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_N)

#Check normality of residuals
hist(resid(model_N), main = "Residual Histogram")
qqnorm(resid(model_N))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_N, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.921,"ns", "150")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
N <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=N, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(N~('%'))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(3.1), size= 6) +
  theme_minimal(base_size = 12)
```


###SD

```{r}
data_specialist <- data_specialist %>% mutate(Type = relevel(Type, ref = "BF")) #changer la reference, mieux vaut que la ref soit celle le mieux renseignée avec le plus d'indv
M0_SD <- lm(log(SD)~1, data= data_specialist)
SD_habitat <- lm(log(SD) ~Type, data= data_specialist)
summary(SD_habitat)
anova(M0_SD,SD_habitat) #2 objets : comparaisons de deux modeles. 
Anova(SD_habitat, type = "II" ) # attention ici Anova avec grand A pour les types II

#plan d'experience equilibrer, il n'y aura aucune difference entre type 1 et type 2. les patates des facteurs ne seront pas confondus, mais distincts, pas d'ambiguité.


SD_forest <- lm(log(SD) ~Type + Forest, data =  data_specialist)
anova(SD_habitat, SD_forest)  #qu'est ce que l'on gagne a rajouter un effet forest après avoir pris en compte l'habitat
Anova(SD_forest, SD_habitat) #symetrisation de l'habitat et de la forest. on regarde l'habitat sachant que forest est deja considere.

model_SD <- lmer(log(SD) ~ Type + Forest + (1|Name), data=data_specialist) 
summary(model_SD)

#Check normality of residuals
hist(resid(model_SD), main = "Residual Histogram")
qqnorm(resid(model_SD))

#estimated marginal means to compare TF specialists and SF specialists for each trait. ?

emm1 <- emmeans(model_SD, specs = pairwise ~ Type, type = "response")
plot(emm1)
means_complex <- emm1$emmeans %>% as.data.frame
contrast <- emm1$contrasts %>% #per default it's tukey adjustment
  as.data.frame

stat.test <- tribble(
        ~group1, ~group2, ~p.adj, ~p.adj.signif, ~y.position,
        "BF","TF",0.13,"ns", "150")


data_specialist$Type <- factor(data_specialist$Type, levels = c("BF", "TF")) 

#option graph 2
SD <- data_specialist %>%
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species)) %>% 
  ggplot(aes(x=Type,y=SD, color=Name)) +
  scale_color_manual(values = c("E. falcata" = "#56B4E9","I. hostmannii"= "#56B4E9", "L. procera"= "#56B4E9", "P. opacum"= "#56B4E9", "E. coriacea"= "#56B4E9", "P. officinalis"= "#56B4E9", "S. globulifera"= "#56B4E9", "V. surinamensis"= "#56B4E9", "C. surinamensis"= "#56B4E9", "D. guianensis"="#E79F02", "I. sagotiana"="#E79F02", "G. hexapetala"="#E79F02", "L. membranacea"="#E79F02", "P. guianensis"="#E79F02", "V. michelii"="#E79F02"))+ 
  geom_boxplot(alpha=0.2) + 
  scale_x_discrete(name =c(""), labels = c("BF" = "SF specialist","TF" = "TF specialist")) +  
  labs(x = "") +
  ylab(expression(SD~(mm^-2))) +
  geom_pointrange(data = means_complex,
                  aes(x = Type, 
                      y = response, 
                      ymin=lower.CL, 
                      ymax= upper.CL), color = 'red', 
                  size =1,
                  show.legend = FALSE) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(1225), size= 6) +
  theme_minimal(base_size = 12) 
```

#### summary plot
```{r}

prow2 <- ggpubr::ggarrange(
  TLP + theme(legend.position="none", axis.text.x = element_blank()),
  Gmin + theme(legend.position="none", axis.text.x = element_blank()),
  LSWC + theme(legend.position="none", axis.text.x = element_blank()),
  MajVLA + theme(legend.position="none", axis.text.x = element_blank()),
  SD + theme(legend.position="none", axis.text.x = element_blank()),
  K + theme(legend.position="none", axis.text.x = element_blank()),
  P + theme(legend.position="none"),
  N + theme(legend.position="none"),
  C + theme(legend.position="none"), 
  labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"),
#  legend = none,
  #common.legend = T,
  #legend = 'bottom',
  nrow= 3, ncol=3)

prow2

# Arrange and annotate
ann1 <- ggplot() + 
  geom_text(aes(x=0, y=0)) +
  annotate("text",  label= "hha",colour = "#56B4E9", fontface="bold",
            size = 6, hjust = 0)

ann2 <- ggplot() + 
  geom_text(aes(x=0, y=0, label = "bold(TFspecialists)", colour = "#E79F02"), 
            parse = TRUE, size = 6, hjust = 0) +
  theme_void()

ggarrange(prow2,                                                  # First row with plot
          ggarrange(ann1, ann2, ncol = 2, labels = c("", "")), # Second row 
          nrow = 2, 
          labels = "", heights = c(2,0.3)                                        # dimensions
          ) 
          


ggsave(filename = "Specialists_plots_H1.png", plot = prow2, bg = "white", width = 10, height = 8, dpi = 600)
```

# Question 2

**(H2) Functional divergence among individuals of generalists between habitats in terms of water usage during the dry season.**

IL y aurait un effet du TWI sur les traits fonctionnels et cela serait propre à chaque espèce.

$$ MComp : Y_{ik} = \mu + \alpha_i + (\beta+ \gamma_{i}) x_{ik} + E_{ik}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) $$

la pente $$\mu$$ commune a tout le monde 
$$\alpha_i$$ effet diff de l'espèce sur l'ordonnée à l'origine
$$\beta$$ pente commune a tout le monde
$$\gamma$$ effet diff sur la pente liée au TWI

H0 : "pas d'effet ni de l'espèce ni du TWI


$$ M0 : Y_{ik} = \mu + E_{ik}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) $$

Le modèle complet:

$$ MComp : Y_{ijk} = TWI + (\beta+ \gamma_{i}) + x_{is} + E_{ijsk}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) $$






##generalist data
```{r data generalist}
Metradica <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv") 

Metradica$Type <- as.character(Metradica$Type)
Metradica$Name <- as.character(Metradica$Name)
Metradica <- Metradica %>% mutate(Type= ifelse(Name == 'Virola_michelii','TF',Type))

Metradica <- Metradica %>% mutate(Type= ifelse(Name == 'Eschweilera_coriacea','BF',Type))

data_generalist <- Metradica %>% filter(Type =="Generalist")

data_generalist <- data_generalist %>%
  mutate(Name = paste0(str_sub(Genus, 1, 1), ". ", Species)) 
```

## graph
```{r graph generalist, echo=FALSE}
library(ggplot2)
ggplot(data_generalist) +
  aes(x = TWI, y = Gmin, colour = Name) +
  geom_point(shape = "circle", size = 1.5) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

```


## gmin
```{r}
MO_generalist <- lm(log(Gmin) ~ 1, data = data_generalist)
M1_generalist <- lm(log(Gmin) ~Species + log(TWI), data = data_generalist) #meme pente pour tout le monde

anova(MO_generalist, M1_generalist)

#on peut rejetter l'hypothèse H0, il y a au moins un effet du TWI ou de l'espece sur Gmin.

M_complet <- lm(log(Gmin) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)

anova(M1_generalist, M_complet)

autoplot(M_complet) #tout parait ok, pas trop de structure,


Model_a <- lmer(log(Gmin) ~ log(TWI) + (1|Name), data= data_generalist)
#plot results

```

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit() %>% 
  mutate(Name = gsub("_", " ", Name)) %>% 
  separate(Name, c("genus", "species")) %>% 
  mutate(Name = paste0(str_sub(genus, 1, 1), ". ", species))

fitlm <-  lmer(log(Gmin) ~ log(TWI) + log(TWI)|Name , data = data_generalist) #i want to estimate the effect of TWI on gmin, not the overall mean of the trait. so i need TWI as a fixed effect.And I also take into account the variability between species.

#fitlm <-  lmer(log(Gmin) ~ 1 + (log(TWI)|Name) , data = data_generalist)

#fitlm <-  lmer(log(Gmin) ~ log(TWI)+ Name + (log(TWI)|Name) , data = data_generalist)

summary(fitlm)
coef(fitlm)$Name
A<- confint(fitlm, oldNames= FALSE)
model_coefs <- coef(fitlm)$Name %>% 
  rename(Intercept = `(Intercept)`, Slope = "log(TWI)") %>% 
  rownames_to_column("Name")


plot_gmin <- left_join(data_generalist, model_coefs, by = "Name")

#trying to get parameters' info
install.packages("parameters")
install.packages("parameters", repos = "https://easystats.r-universe.dev")
remotes::install_github("easystats/parameters")

library(parameters)
library(easystats)
standard_error(fitlm, effects = "random")






#plot

data_generalist$predlm = predict(fitlm)


gmin <- plot_gmin %>%
      ggplot(aes(x = log(TWI), y = log(Gmin), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
      scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_abline(aes(intercept = Intercept, 
                  slope = Slope,
                  colour = Name
                  ),
              size = 0.8
              )
      #geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 0.8) +
      # annotate(geom = 'text', x = 2.5, y = 2.4,
      #      label = bquote("R^2 == 0.28"), size=5, parse = TRUE)+
      theme(legend.text = element_text(face = "italic"))


gmin
ggsave(filename = "Generalist_gmin_twi.png", plot = gmin, bg = "white", width = 10, height = 8, dpi = 600)

```
pr(>|t|) indicates that the probaility of observing any value larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (TWI) and response (Gmin) variables *due to chance.* here, we cannot reject the null hypothesis, and there is no relationships between twi and gmin. Very weak R2, TWI does not explain Gmin.

##gmin bis
```{r}
data_generalist2 <- data_generalist %>% dplyr::select(Name, Gmin, TWI) %>% na.omit()

m2 <- lm(log(Gmin) ~ log(TWI) +Name + log(TWI):Name, data = data_generalist)


plot(emmeans(m2, ~ log(TWI)*Name)) 

emmip(m2, Name ~log(TWI), cov.reduce=FALSE, CIs = TRUE)

data_generalist2 %>%
      ggplot(aes(x = log(TWI), y = log(Gmin), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
      scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
     geom_line(data = cbind(data_generalist2, pred = predict(m2)), aes(y = pred), size = 0.8)
      
```


##gmin SMA

SMA alll you need to know : Methods in Ecology and Evolution Warton et al 2012 as well as Wright, Reich & Westoby 2001.
```{r}
df <- data_generalist %>% dplyr::select(Name, Gmin, TWI) %>% na.omit()

library(smatr)
# Fit SMA's separately
# and test for common slope:
sm <- sma(Gmin~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)
# 
# H0 : slopes are equal.
# Likelihood ratio statistic : 12.86 with 5 degrees of freedom
# P-value : 0.024708 we reject H0, we have different slopes, meaning different generalist strategies.

# get sma summary into a data.frame
test0_slope_gmin <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_gmin$Trait <- 'gmin'

test0_slope_gmin %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/gmin.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

#test y-intercept differences among the individual slopes. if no differences found, then it allows for a common SMA to be fitted to examie group shifts.
test_elev <-  sma(Gmin~TWI+Name, log = "xy", data=df)
test_elev


# plot into ggplot
gmin <- ggplot(df, aes(x=TWI, y=Gmin, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
  geom_abline(data=test0_slope_gmin %>% filter(Species %in% c("B. prouacensis","C. guianensis")),aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 
 

#this is the plot from the smatr package for comparison
plot(sm)




```


##TLP
```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(-TLP) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)

data_generalist$predlm = predict(fitlm)

(mm_plot <- ggplot(data_generalist, aes(x = log(TWI), y = log(-TLP), colour = Name)) +
      facet_wrap(~Forest, nrow=1) +   # a panel for each mountain range
      geom_point(alpha = 0.5) +
      theme_classic() +
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))  # adding space between panels
)

TLP<-ggplot(data_generalist, aes(x = log(TWI), y = log(-TLP), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
      scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) + 
      annotate(geom = 'text', x = 2.5, y = 0.78, 
           label = bquote("R^2 == 0.70"), size=5, parse = TRUE) +
        
      theme(legend.text = element_text(face = "italic"))

TLP
ggsave(filename = "Generalist_tlp_twi.png", plot = TLP, bg = "white", width = 10, height = 8, dpi = 600)
```
pr(>|t|) indicates that the probability of observing any value larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (TWI) and response (TLP) variables *due to chance.* here, we can reject the null hypothesis concerning some species, and there is a relationship between twi and tlp. We have a relatively strong R2 of 70 %, meaning that 70% of the varaince dounf in the response variable tlp can be explained by the predictor variable (twi). the f stat, larger than 1, also encourages us to reject the null hypothesis. 

##TLP SMA
```{r}
df <- data_generalist %>% dplyr::select(Name, TLP, TWI, Forest, Habitat) %>% na.omit() %>% mutate(negTLP = -TLP)

library(smatr)
# Fit SMA's separately at each of high and low rainfall sites,
# and test for common slope:
sm <- sma(negTLP~TWI*Name, log="xy", slope.test = 0, data=df)


# get sma coefficients into a data.frame
bb <- data.frame(coef(sm))
bb <- bb %>%
  rownames_to_column(var = "Name") 

## calculate end coordinates for segment
bb$min_x <- min(df$negTLP, na.rm = TRUE)
bb$max_x <- max(df$negTLP, na.rm = TRUE)
bb <- bb %>%
  mutate(min_y = (slope*min_x) + elevation) %>%
  mutate(max_y = (slope*max_x) + elevation) 

bb <- bb %>%
  mutate(elevation = (-1)*elevation) %>%
  mutate(slope = (-1)*slope) %>%
  mutate(min_x = (-1)*min_x) %>%
  mutate(min_y= (-1)*min_y) %>%
  mutate(max_x = (-1)*max_x) %>%
  mutate(max_y = (1)*max_y)
  
# get sma summary into a data.frame
test0_slope_TLP <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_TLP$Trait <- 'TLP'

test0_slope_TLP %>% 
  mutate(Int = (-1)*Int) %>%
  mutate(Int_lowCI = (-1)*Int_lowCI) %>%
  mutate(Int_highCI= (-1)*Int_highCI) %>%
  mutate(Slope = (-1)*Slope) %>%
  mutate(Slope_lowCI= (-1)*Slope_lowCI) %>%
  mutate(Slope_highCI = (-1)*Slope_highCI) %>%
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/TLP.png", zoom = 5)

# plot into ggplot
tlp <- ggplot(df, aes(x=TWI, y=negTLP, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans= reverselog_trans(10)) +
  scale_x_continuous(trans = 'log10') +
  geom_abline(data=bb %>% filter(Name== "B. prouacensis"),aes(intercept=elevation, slope=slope, color = Name))+
  theme_minimal()+
  labs(y= "TLP")+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"), legend.position = "bottom")

#add manually the - signs

plot(sm)
```


##LSWC
```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(LSWC) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)

data_generalist$predlm = predict(fitlm)

(mm_plot <- ggplot(data_generalist, aes(x = log(TWI), y = log(LSWC), colour = Name)) +
      facet_wrap(~Forest, nrow=1) +   # a panel for each mountain range
      geom_point(alpha = 0.5) +
      theme_classic() +
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))  # adding space between panels
)

LSWC <- ggplot(data_generalist, aes(x = log(TWI), y = log(LSWC), colour = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
      scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      

LSWC
ggsave(filename = "Generalist_LSWC_twi.png", plot = LSWC, bg = "white", width = 10, height = 8, dpi = 600)
```
pr(>|t|) indicates that the probability of observing any value larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (TWI) and response (LSWC) variables *due to chance.* here, we can reject the null hypothesis concerning con.gui, and there is a relationship between twi and lswc. We have a relatively strong R2 of 64 %, meaning that 64% of the variance found in the response variable lswc can be explained by the predictor variable (twi). the f stat, larger than 1, also encourages us to reject the null hypothesis. 


##SMA LSWC
```{r}
df <- data_generalist %>% dplyr::select(Name, LSWC, TWI) %>% na.omit()

# Fit SMA's separately
# and test for common slope:
sm <- sma(LSWC~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)
# Results of comparing lines among groups.

# H0 : slopes are equal.
# Likelihood ratio statistic : 40.12 with 5 degrees of freedom
# P-value : 1.414e-07 

# get sma summary into a data.frame
test0_slope_lswc <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_lswc$Trait <- 'LSWC'

test0_slope_lswc %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/LSWC.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
LSWC <- ggplot(df, aes(x=TWI, y=LSWC, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
 # geom_abline(data=test0_slope,aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 
 

#this is the plot from the smatr package for comparison
plot(sm)

```

##MajVLA

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(MajVLA) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)
data_generalist$predlm = predict(fitlm)

(mm_plot <- ggplot(data_generalist, aes(x = log(TWI), y = log(MajVLA), colour = Name)) +
      facet_wrap(~Forest, nrow=1) +   # a panel for each mountain range
      geom_point(alpha = 0.5) +
      theme_classic() +
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))  # adding space between panels
)

MajVLA <- ggplot(data_generalist, aes(x = log(TWI), y = log(MajVLA), colour = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
      scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
   

MajVLA
ggsave(filename = "Generalist_majvla_twi.png", plot = MajVLA, bg = "white", width = 10, height = 8, dpi = 600)
```

pr(>|t|) indicates that the probability of observing any value larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (TWI) and response (majvla) variables *due to chance.* here, we can reject the null hypothesis concerning tac.mel, and there is a relationship between twi and Majvla. We have a relatively strong R2 of 60 %, meaning that 60% of the variance found in the response variable Majvla can be explained by the predictor variable (twi). the f stat, larger than 1, also encourages us to reject the null hypothesis.

##Majval SMA
```{r}
df <- data_generalist %>% dplyr::select(Name, MajVLA, TWI) %>% na.omit()

# Fit SMA
sm <- sma(MajVLA~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)
# Results of comparing lines among groups.
# H0 : slopes are equal.
# Likelihood ratio statistic : 40.12 with 5 degrees of freedom
# P-value : 1.414e-07 

# get sma summary into a data.frame
test0_slope_majvla <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_majvla$Trait <- 'MajVLA'

test0_slope_majvla %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/MajVLA.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
MajVLA <- ggplot(df, aes(x=TWI, y=MajVLA, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
  geom_abline(data=test0_slope_majvla %>% filter(Species == "T. melinonii"),aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 

#this is the plot from the smatr package for comparison
plot(sm)
```


##SD

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(SD) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)
data_generalist$predlm = predict(fitlm)

SD <- ggplot(data_generalist, aes(x = log(TWI), y = log(SD), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
   

SD
ggsave(filename = "Generalist_SD_twi.png", plot = SD, bg = "white", width = 10, height = 8, dpi = 600)
```

pr(>|t|) indicates that the probability of observing any value larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (TWI) and response (SD) variables *due to chance.* here, i'm not sure we that can reject the null hypothesis, and if there is a relationship between twi and SD. We have a R2 of 54 %, meaning that 54% of the variance found in the response variable SD can be explained by the predictor variable (twi). the f stat, larger than 1, also encourages us to reject the null hypothesis. 

##SD SMA 

*au lieu de 225 generalist, we have here 173 indv.*
```{r}
df <- data_generalist %>% dplyr::select(Name, SD, TWI, Forest, Habitat) %>% na.omit()


# Fit SMA
sm <- sma(SD~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)
# Results of comparing lines among groups.
# H0 : slopes are equal.
# Likelihood ratio statistic : 10.01 with 5 degrees of freedom
# P-value : 0.074985 

#slopes are equal, we can fit a common slope!! But the common slope is different from 0

# H0 : common slope not different from 0 
# Likelihood ratio statistic = 5598 with 6 degrees of freedom under H0
# P-value : < 2.22e-16 

# get sma summary into a data.frame
test0_slope_SD <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_SD$Trait <- 'SD'

test0_slope_SD %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/SD.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
SD <- ggplot(df, aes(x=TWI, y=SD, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
 # geom_abline(data=test0_slope_SD,aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 

#this is the plot from the smatr package for comparison
plot(sm)
```


##K

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(K) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)
data_generalist$predlm = predict(fitlm)

K <- ggplot(data_generalist, aes(x = log(TWI), y = log(K), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
     scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
     

K
ggsave(filename = "Generalist_K_twi.png", plot = K, bg = "white", width = 10, height = 8, dpi = 600)
```

pr(>|t|) indicates that the probability of observing any value larger than t. A small p-value indicates that it is unlikely we will observe a relationship between the predictor (TWI) and response (K) variables *due to chance.* here, we can reject the null hypothesis concerning tac.mel, and there is a relationship between twi and K. We have a relatively strong R2 of 44 %, meaning that 44% of the variance found in the response variable K can be explained by the predictor variable (twi). the f stat, larger than 1, also encourages us to reject the null hypothesis. 

##K SMA
```{r}
df <- data_generalist %>% dplyr::select(Name, K, TWI) %>% na.omit()


# Fit SMA
sm <- sma(K~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)


# get sma summary into a data.frame
test0_slope_K <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_K$Trait <- 'K'

test0_slope_K %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/K.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
K <- ggplot(df, aes(x=TWI, y=K, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
  geom_abline(data=test0_slope_K %>% filter(Species == "J. copaia subsp. copaia"),aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 

#this is the plot from the smatr package for comparison
plot(sm)
```


##P

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(P) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)
data_generalist$predlm = predict(fitlm)

P <- ggplot(data_generalist, aes(x = log(TWI), y = log(P), colour = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
   scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1)   # adding predicted line from mixed model 
   

P
ggsave(filename = "Generalist_P_twi.png", plot = P, bg = "white", width = 10, height = 8, dpi = 600)
```

##P SMA
```{r}
df <- data_generalist %>% dplyr::select(Name, P, TWI, Forest, Habitat) %>% na.omit()


# Fit SMA
sm <- sma(P~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)

# get sma summary into a data.frame
test0_slope_P <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_P$Trait <- 'P'

test0_slope_P %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/P.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
P <- ggplot(df, aes(x=TWI, y=P, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
 # geom_abline(data=test0_slope_P,aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 

#this is the plot from the smatr package for comparison
plot(sm)
```


##N

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(N) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)
data_generalist$predlm = predict(fitlm)

N <- ggplot(data_generalist, aes(x = log(TWI), y = log(N), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
    scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) # adding predicted line from mixed model 
   

N
ggsave(filename = "Generalist_N_twi.png", plot = N, bg = "white", width = 10, height = 8, dpi = 600)
```

##N SMA
```{r}
df <- data_generalist %>% dplyr::select(Name, N, TWI, Forest, Habitat) %>% na.omit()

# Fit SMA
sm <- sma(N~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)

# get sma summary into a data.frame
test0_slope_N <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_N$Trait <- 'N'

test0_slope_N %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/N.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
N <- ggplot(df, aes(x=TWI, y=N, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
  geom_abline(data=test0_slope_N %>% filter(Species == "H. heteromorphus"),aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 

#this is the plot from the smatr package for comparison
plot(sm)
```


##C

```{r}

# Extract the prediction data frame

# Plot the predictions 
data_generalist <- data_generalist %>% na.omit()
fitlm <-  lm(log(C) ~Name + log(TWI) + Name:log(TWI), data = data_generalist)
summary(fitlm)
data_generalist$predlm = predict(fitlm)

C <- ggplot(data_generalist, aes(x = log(TWI), y = log(C), color = Name)) +
      geom_point(alpha = 0.5) +
      theme_classic() +
   scale_color_discrete(name ="Species")+
      theme(legend.position = "bottom")+
      geom_line(data = cbind(data_generalist, pred = predict(fitlm)), aes(y = pred), size = 1) 

C
ggsave(filename = "Generalist_C_twi.png", plot = C, bg = "white", width = 10, height = 8, dpi = 600)
```
## C SMA
```{r}
df <- data_generalist %>% dplyr::select(Name, C, TWI) %>% na.omit()


# Fit SMA
sm <- sma(C~TWI*Name, log="xy", slope.test = 0, data=df)

#get the summary table
summary(sm)
# Results of comparing lines among groups.
# H0 : slopes are equal.
# Likelihood ratio statistic : 10.01 with 5 degrees of freedom
# P-value : 0.074985 

#slopes are equal, we can fit a common slope!! But the common slope is different from 0

# H0 : common slope not different from 0 
# Likelihood ratio statistic = 5598 with 6 degrees of freedom under H0
# P-value : < 2.22e-16 

# get sma summary into a data.frame
test0_slope_C <- data.frame(sm[["groupsummary"]]) %>% 
  rename("Species" = "group") %>%
  dplyr::select(-Elev_test, -Elev_test_p)

test0_slope_C$Trait <- 'C'

test0_slope_C %>% 
  relocate("Trait", .before = "Species") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/C.png", zoom = 5)


#Checking assumptions :residual plots, to check the critical assumptions of linearity and equal variance at all fitted values (via a residuals vs. fitted values plot)

#Checking assumptions : normally distributed residuals (via a normal quantile plot). 

plot(sm, which= "residual" ) 
plot(sm, which= "qq" )

# plot into ggplot
C <- ggplot(df, aes(x=TWI, y=C, color =Name)) + 
  geom_point(shape=21) +
  scale_y_continuous(trans = 'log10')+
  scale_x_continuous(trans = 'log10') +
 # geom_abline(data=test0_slope_C,aes(intercept=Int, slope=Slope, color = Species))+
  theme_minimal()+
  scale_color_discrete(name ="Generalist species")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") 

#this is the plot from the smatr package for comparison
plot(sm)
```


##Combine
```{r}
prow2 <- ggpubr::ggarrange(
  TLP + theme(legend.position="none", axis.title.x = element_blank()),
  gmin + theme(legend.position="none", axis.title.x = element_blank()),
  LSWC + theme(legend.position="none", axis.title.x = element_blank()),
  MajVLA + theme(legend.position="none", axis.title.x = element_blank()),
  SD + theme(legend.position="none", axis.title.x = element_blank()),
  K + theme(legend.position="none", axis.title.x = element_blank()),
  P + theme(legend.position="none"),
  N + theme(legend.position="none"),
  C + theme(legend.position="none"), 
  labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"),
  common.legend = T,
  legend = 'bottom',
  nrow= 3, ncol=3)

ggsave(filename = "Generalist_plots_H2.png", plot = prow2, bg = "white", width = 10, height = 8, dpi = 600)
```

###combine SMA
```{r}
sma <- ggpubr::ggarrange(
  tlp + theme(legend.position="none", axis.title.x = element_blank()),
  gmin + theme(legend.position="none", axis.title.x = element_blank()),
  LSWC + theme(legend.position="none", axis.title.x = element_blank()),
  MajVLA + theme(legend.position="none", axis.title.x = element_blank()),
  SD + theme(legend.position="none", axis.title.x = element_blank()),
  K + theme(legend.position="none", axis.title.x = element_blank()),
  P + theme(legend.position="none"),
  N + theme(legend.position="none"),
  C + theme(legend.position="none"), 
  labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"),
  common.legend = T,
  legend = 'bottom',
  nrow= 3, ncol=3)

ggsave(filename = "Generalist_plots_H2_SMA_significatif.png", plot = sma, bg = "white", width = 10, height = 8, dpi = 600)
```

And combine tables
```{r}
table <- rbind(test0_slope_gmin, test0_slope_TLP, test0_slope_lswc, test0_slope_majvla, test0_slope_SD, test0_slope_N, test0_slope_C, test0_slope_P, test0_slope_K)

table$Slope_lowCI <- as.character(table$Slope_lowCI) 
table$Slope_highCI <- as.character(table$Slope_highCI) 
table$Slope_lowCI <- substr(table$Slope_lowCI, 1, 5)  
table$Slope_highCI <- substr(table$Slope_highCI, 1, 5) 
  
table <- table %>%
  mutate(CI = paste0(Slope_lowCI, ";", Slope_highCI )) 


table %>% 
  relocate("Trait", .before = "Species") %>%
  dplyr::select(-Int_lowCI, -Int_highCI, -Slope_lowCI, -Slope_highCI, -Slope_test, -Slope_test_p) %>%
  rename(Intercept = Int, 
         pvalue = pval,
         `R²` = r2) %>%
  relocate("Intercept", .before= "Slope") %>%
  relocate("CI", .after= "Slope") %>%
  kbl(caption = "Summary of standardised major axis regressions between log-transformed traits with TWI for each generalist species.", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(2, italic = T) %>%
  collapse_rows(columns = 1, valign = "middle") %>%
  save_kable(file = "../METRADICAproject/Results/SMA/ALL.png", zoom = 5)
```


# Question 3
**(H3) Generalist species express a higher intraspecific trait variability than specialist species.**

CV to quantify ITV : absolute variation of the intraspecific trait with respect to the interspecific mean. 

CV is defined as the ratio of the standard deviation \sigma to the mean , expressed as a percentage. CV is convenient to compare variation of traits among species as it requires no ad hoc assumptions and is unitless. 

## CV
```{r Coefficient of variation calculation}
#data ----------
Metradica <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv") 

Metradica$Type <- as.character(Metradica$Type)
Metradica$Name <- as.character(Metradica$Name)

# For generalists ----------

cv_G <- Metradica %>% filter(Type =="Generalist") %>% 
  rename(Carbon = C,
         Nitrogen = N,
         Potassium = K, 
         Phosphorous = P) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD", "Carbon", "Nitrogen", "Phosphorous", "Potassium"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), log) %>% 
  mutate(TLP = -TLP) %>%
  group_by(Name) %>% 
  summarise_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), funs(cv))

cv_G <- bind_rows(cv_G,
                  ungroup(cv_G) %>%
                  summarise_all(mean) %>%
                  mutate(Name = "mean"))

cv_long_G <- reshape2::melt(cv_G, "Name", variable.name = "trait", value.name = "CV")

cv_long_G$Type <- c("Generalist")

# For TF specialist -------------

cv_TF <- Metradica %>% filter(Type =="TF") %>%
  rename(Carbon = C,
         Nitrogen = N,
         Potassium = K, 
         Phosphorous = P) %>% 
    mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), log) %>% 
  mutate(TLP = -TLP)%>%
  group_by(Name) %>% 
  summarise_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), funs(cv))


cv_TF <- bind_rows(cv_TF,
                   ungroup(cv_TF) %>% 
                  summarise_all(mean) %>% 
                  mutate(Name = "mean"))

cv_TF$SD[7] <- (cv_TF$SD[1]+cv_TF$SD[2]+cv_TF$SD[3]+cv_TF$SD[5]+cv_TF$SD[6])/5

cv_long_TF <- reshape2::melt(cv_TF, "Name", variable.name = "trait", value.name = "CV")

cv_long_TF$Type <- c("TF")

# For BF specialist-----------

cv_BF <-  Metradica %>% filter(Type =="BF") %>% 
   rename(Carbon = C,
         Nitrogen = N,
         Potassium = K, 
         Phosphorous = P) %>% 
    mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), log) %>% 
  mutate(TLP = -TLP)%>%
  group_by(Name) %>% 
  summarise_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD",  "Carbon", "Nitrogen", "Phosphorous", "Potassium"), funs(cv))

cv_BF <- bind_rows(cv_BF,
                ungroup(cv_BF) %>% 
                  summarise_all(mean) %>% 
                  mutate(Name = "mean")) 

cv_BF$SD[10] <- (cv_BF$SD[2]+cv_BF$SD[3]+cv_BF$SD[4]+cv_BF$SD[5]+cv_BF$SD[6]+cv_BF$SD[7]+cv_BF$SD[8]+cv_BF$SD[9])/8

cv_long_BF <- reshape2::melt(cv_BF, "Name", variable.name = "trait", value.name = "CV") 

cv_long_BF$Type <- c("BF")

cv_tot <- bind_rows(cv_long_BF, cv_long_TF, cv_long_G) 


```


### plot cv
```{r Plot CV}
# plot all 
#option 1
cv_plot <- cv_tot %>% 
  mutate(CV =CV*100) %>%
  mutate(trait = dplyr::recode(trait, "Gmin" = "g[min]", "TLP" = "pi[tlp]")) %>%
  filter(Name != "mean") %>% 
  ggplot(aes(x = Type, y = CV, fill = Type)) +
  geom_jitter() + 
  geom_boxplot(alpha=0.7)+
  scale_fill_manual("Species'\npreference", 
                    values = c("#56B4E9", "#009E72",  "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "Generalist" = "Generalist", 
                               "BF" = "SF specialist")) +
  scale_shape_discrete("Species'\npreference") +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank())+
  theme(plot.title = element_text(size=14, face="bold")) +
  ylab("Coefficient of variation (%)") + xlab("")+
    theme_minimal(base_size = 22) +
  facet_wrap(~trait, scales ="free_y") +
  theme(legend.position = "bottom")

#option 2
cv_tot$Type <- dplyr::recode(cv_tot$Type, "TF" = "TF specialist", "BF" = "SF specialist")

cv_plot <- cv_tot %>% 
  # mutate(trait = dplyr::recode(trait, "Gmin" = "g[min]", "TLP" = "TLP", "C"= "C", "N" = "N", "K"= "K", "LSWC" = "LSWC", "MajVLA" = "MajVLA", "P" = "P", "SD" = "SD")) %>%
   mutate(trait = dplyr::recode(trait, 
                                "Gmin" = "g[min]", 
                                "TLP" = "TLP", 
                                "Carbon"= "Carbon", 
                                "Nitrogen" = "Nitrogen", 
                                "Potassium"= "Potassium", 
                                "LSWC" = "LSWC", 
                                "MajVLA" = "MajVLA", 
                                "Phosphorous" = "Phosphorous", 
                                "SD" = "SD")) %>%
  mutate(CV =CV*100) %>%
  filter(Name != "mean") %>% 
  ggplot(aes(x = Type, y = CV, color = Type)) +
  #geom_point()+
  geom_jitter(size = 2) +
  scale_color_manual(
    values = c(Generalist = "#009E72",
    `SF specialist` = "#56B4E9",
    `TF specialist` = "#E79F02")
  ) +
  scale_shape_discrete("Species'\npreference") +
  theme_minimal(base_size = 12) +
   theme(axis.text.x = element_blank())+
    theme(plot.title = element_text(size=12, face="bold")) +
  facet_wrap(~trait, scales ="free_y", labeller = label_parsed) +
  labs(x = "", y = "Coefficient of variation (%)", color = "Species' preference") +
  theme(legend.position = "bottom")
 

cv_plot

ggsave(filename = "CV_plot.png", plot = cv_plot, bg = "white", width = 7, height = 5, dpi = 600)

```


###Anova on cv
```{r CV anova}
# Anova on CV
#We want to know if there is any significant difference between the average cv for each trait for the three habitat preferences.
cv_BF$Type <- c("BF")
cv_TF$Type <- c("TF")
cv_G$Type <- c("Generalist")

cv_tot2 <- rbind(cv_BF, cv_TF, cv_G) %>% filter(Name != "mean")

cv_tot2$Type <- as.factor(cv_tot2$Type)
levels(cv_tot2$Type)


#gmin-----------
# Compute the analysis of variance
res.aov <- aov(Gmin ~ Type, data = cv_tot2 %>% dplyr::select(Name, Gmin, Type) %>%
  mutate(Gmin =Gmin*100))
# 1. Homogeneity of variances
plot(res.aov, 1)
# 2. Normality
plot(res.aov, 2)
# Summary of the analysis
summary(res.aov)
#non parametric test
kruskal.test(Gmin ~ Type, data = cv_tot2 %>% dplyr::select(Name, Gmin, Type)) #p-value = 0.3252

cv_gmin <- cv_tot2 %>% dplyr::select(Name, Gmin, Type) %>%
  mutate(Gmin =Gmin*100) %>%
  ggplot() +
  aes(x = Type, y = Gmin, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
  labs(y = bquote(g[min])) +
  scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =100) #ns


#tlp --------------------------
res.aov <- aov(TLP ~ Type, data = cv_tot2 %>% dplyr::select(Name,TLP, Type) %>%
  mutate(TLP =TLP*100) )
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov)
kruskal.test(TLP ~ Type, data = cv_tot2 %>% dplyr::select(Name,TLP, Type) %>%
  mutate(TLP =TLP*100) ) #p-value = 0.2233

cv_tlp <- cv_tot2 %>% dplyr::select(Name,TLP, Type) %>%
  mutate(TLP =TLP*100) %>%
  ggplot() +
  aes(x = Type, y = TLP, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() +
 # labs(y = bquote(pi[tlp])) +
    scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =29) #ns

#SD --------------
res.aov <- aov(SD ~ Type, data = cv_tot2)
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov)
kruskal.test(SD ~ Type, data = cv_tot2) #p-value = 0.798

cv_SD <- cv_tot2 %>% dplyr::select(Name,SD, Type) %>%
  mutate(SD =SD*100) %>%
  ggplot() +
  aes(x = Type, y = SD, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() +
   scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
    stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =8) #ns

#majvla------------------
res.aov <- aov(MajVLA ~ Type, data = cv_tot2 %>% dplyr::select(Name,MajVLA, Type) )
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov)
kruskal.test(MajVLA ~ Type, data = cv_tot2 %>% dplyr::select(Name,MajVLA, Type) ) # p-value = 0.8236

cv_MajVLA <- cv_tot2 %>% dplyr::select(Name,MajVLA, Type) %>%
  mutate(MajVLA =MajVLA*100) %>%
  ggplot() +
  aes(x = Type, y = MajVLA, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
   scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =30) #ns

#K ---------------

res.aov <- aov(K ~ Type, data = cv_tot2)
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov) # p-value = 0.0213 *

compare_means(K ~ Type,  data = cv_tot2, method = "anova", p.adjust.method = "fdr") # p-value = 0.0213
compare_means(K ~ Type,  data = cv_tot2 %>% dplyr::select(Name,K, Type), method = "t.test") #generalist and BF are different; method = t.test.

my_comparison <- list(c("BF", "Generalist"), c("BF", "TF"), c("Generalist", "TF"))

#graph
cv_K <- cv_tot2 %>% dplyr::select(Name,K, Type)%>%
  mutate(K =K*100) %>%
  ggplot() +
  aes(x = Type, y = K, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
  scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(method ="anova", size= 4, label.x =0.9, label.y =37) + stat_compare_means(comparisons = list(c("BF", "Generalist")), label.y = c(32, 35, 39), method = "t.test")  # Add pairwise comparisons p-value 

#C---------
cv_C <- cv_tot2 %>% dplyr::select(Name,C, Type) %>%
  mutate(C =C*100) %>%
  ggplot() +
  aes(x = Type, y = C, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
  scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =2.2)
res.aov <- aov(C ~ Type, data = cv_tot2 %>% dplyr::select(Name,C, Type))
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov) 

#P --------------
res.aov <- aov(P ~ Type, data = cv_tot2)
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov) 

cv_P <- cv_tot2 %>% dplyr::select(Name,P, Type)%>% 
  mutate(P =P*100) %>%
  ggplot() +
  aes(x = Type, y = P, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
  scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =100)

#N ----------------
res.aov <- aov(N ~ Type, data = cv_tot2)
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov)
cv_N <- cv_tot2 %>% dplyr::select(Name,N, Type) %>%
  mutate(N =N*100) %>%
  ggplot() +
  aes(x = Type, y = N, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
  scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =80)


#LSWC ------------------
res.aov <- aov(LSWC ~ Type, data = cv_tot2)
plot(res.aov, 1)
plot(res.aov, 2)
summary(res.aov)
cv_LSWC <- cv_tot2 %>% dplyr::select(Name,LSWC, Type)%>%
  mutate(LSWC =LSWC*100) %>%
  ggplot() +
  aes(x = Type, y = LSWC, fill= Type) +
  geom_boxplot(alpha =0.7) +
  geom_jitter() + 
  scale_fill_manual("Habitat\npreference", 
                    values = c("#56B4E9", "#009E72", "#E79F02"), 
                    labels = c("TF" = "TF specialist",
                               "BF" = "SF specialist", 
                               "Generalist" = "Generalist")) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank(), legend.position = "bottom")+
  stat_compare_means(label = "p.signif", method ="anova", size= 5, label.x =2, label.y =5.5)


#combine all graphs -------------------
prow_cv <- ggpubr::ggarrange(
  cv_tlp + theme(legend.position="none", axis.title.x = element_blank()),
  cv_gmin + theme(legend.position="none", axis.title.x = element_blank()),
  cv_LSWC + theme(legend.position="none", axis.title.x = element_blank()),
  cv_MajVLA + theme(legend.position="none", axis.title.x = element_blank()),
  cv_SD + theme(legend.position="none", axis.title.x = element_blank()),
  cv_K + theme(legend.position="none", axis.title.x = element_blank()),
  cv_P + theme(legend.position="none"),
  cv_N + theme(legend.position="none"),
  cv_C + theme(legend.position="none"), 
 # labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"),
  common.legend = T,
  legend = 'bottom',
  nrow= 3, ncol=3)

ggsave(filename = "CV_plots_H3.png", plot = prow_cv, bg = "white", width = 10, height = 10, dpi = 600)
```


##VP - variance partitioning

*Inspiration from Julie Messier's code: https://juliemessier.org/code/*


```{r variance partitionning}
# Take into account only generalists. Variance partitioning 

Metradica <- read_csv("C:/Users/marion.boisseaux/Dropbox/Mon PC (Jaboty20)/Documents/METRADICA/METRADICAproject/Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv")
sub_data_G <- Metradica %>% filter(Type == 'Generalist')

vars <- sub_data_G %>% 
  dplyr::select(Forest, Habitat, Name, LSWC, TLP, Gmin, MajVLA, N, C, P, K, SD) %>% 
  reshape2::melt(c("Forest", "Habitat", "Name"), variable.name = "trait") %>% 
  na.omit() %>% 
  group_by(trait, Name) %>%
  group_by(trait) %>%
  do(var = nlme::lme(value ~ 1, random=~1|Forest/Habitat/Name, data = .) %>% 
       ape::varcomp(scale = F, cum = F) %>% 
       as.vector() %>% 
       data.frame(level = c("Forest", "Habitat", "Name", "Within"), variance = as.vector(.))) %>% 
  unnest(var) %>% 
  group_by(trait) %>% 
  mutate(pct = variance / sum(variance)*100)

#plot graph, first rough draft version
ggplot(vars) +
  aes(x = trait, y = pct, fill = level) +
  geom_col() +
   ylab("") + xlab("")+
  scale_fill_manual("",
    values =c("#029A88","#C33110", "#CCBC44", "#BBBBBB"), 
                    labels = c("Forest" = "Forest\n(Paracou, Bafog, Kaw)",
                               "Habitat" = "Habitat\n(SF, TF)", 
                               "Species" = "Species\n(n=6)",
                               "Within" = "Individuals")) +
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") +
  theme_minimal()

#second longer version.
#variance partitionning for these traits

varcomp.gmin<-varcomp(lme(log(Gmin)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1) 

varcomp.gmin$Trait <- c("Gmin")

varcomp.tlp<-varcomp(lme(log(-TLP)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.tlp$Trait <- c("TLP")

varcomp.LSWC<-varcomp(lme(log(LSWC)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.LSWC$Trait <- c("LSWC")

varcomp.MajVLA<-varcomp(lme(log(MajVLA)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.MajVLA$Trait <- c("MajVLA")

varcomp.SD<-varcomp(lme(log(SD)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.SD$Trait <- c("SD")

varcomp.C<-varcomp(lme(log(C)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.C$Trait <- c("C")

varcomp.K<-varcomp(lme(log(K)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.K$Trait <- c("K")

varcomp.N<-varcomp(lme(log(N)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.N$Trait <- c("N")

varcomp.P<-varcomp(lme(log(P)~1,random=~1|Forest/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.P$Trait <- c("P")


vars <- bind_rows(varcomp.gmin, varcomp.tlp, varcomp.MajVLA, varcomp.LSWC, varcomp.SD, varcomp.C, varcomp.N, varcomp.K, varcomp.P) 


vars <- reshape2::melt(vars, "Trait", variable.name = "level", value.name = "variance") 

#plot


v<- vars %>%  
  #mutate(Trait = dplyr::recode(Trait, "Gmin" = "g[min]", "TLP" = "pi[tlp]")) %>%
  mutate(Trait = dplyr::recode(Trait, "Gmin" = "g[min]")) %>%
  ggplot(aes(fill=level, y=variance, x=Trait)) + 
  geom_bar(position="stack", stat="identity") +
  theme_minimal(base_size = 22) +
  ylab("") + xlab("")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") +
    scale_fill_manual("", values = c("#029A88","#C33110", "#CCBC44", "#BBBBBB"), 
                    labels = c("Forest" = "Forest\n(Paracou, Bafog, Kaw)",
                               "Habitat" = "Habitat\n(SF, TF)", 
                               "Name" = "Species\n(n=6)")) +
  scale_x_discrete(labels = scales::label_parse())
  #ggtitle("Portion of total variance (%)")
v
ggsave(filename = "Variance_partitioning_v1.png", plot = v, bg = "white", width = 10, height = 8, dpi = 600)
```

##v2
```{r VP - plots}
#variance partitionning for these traits V2 - with plots as an additional level
library(ape)

varcomp.gmin<-varcomp(lme(log(Gmin)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1) 

varcomp.gmin$Trait <- c("Gmin")

varcomp.tlp<-varcomp(lme(log(-TLP)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.tlp$Trait <- c("TLP")

varcomp.LSWC<-varcomp(lme(log(LSWC)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.LSWC$Trait <- c("LSWC")

varcomp.MajVLA<-varcomp(lme(log(MajVLA)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.MajVLA$Trait <- c("MajVLA")

varcomp.SD<-varcomp(lme(log(SD)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.SD$Trait <- c("SD")

varcomp.C<-varcomp(lme(log(C)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.C$Trait <- c("C")

varcomp.K<-varcomp(lme(log(K)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.K$Trait <- c("K")

varcomp.N<-varcomp(lme(log(N)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.N$Trait <- c("N")

varcomp.P<-varcomp(lme(log(P)~1,random=~1|Forest/Plot/Habitat/Name, data = sub_data_G, na.action = na.omit),1)

varcomp.P$Trait <- c("P")


vars <- bind_rows(varcomp.gmin, varcomp.tlp, varcomp.MajVLA, varcomp.LSWC, varcomp.SD, varcomp.N, varcomp.K, varcomp.C, varcomp.P) 


vars <- reshape2::melt(vars, "Trait", variable.name = "level", value.name = "variance") 

#Type


v2<- vars %>%  
  mutate(Trait = dplyr::recode(Trait, "Gmin" = "g[min]", "TLP" = "pi[tlp]")) %>%
  ggplot(aes(fill=level, y=variance, x=Trait)) + 
  geom_bar(position="stack", stat="identity") +
  theme_minimal(base_size = 22) +
  ylab("") + xlab("")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") +
    scale_fill_manual("", values = c("#029A88","#84C3E4", "#C33110", "#CCBC44", "#BBBBBB"), 
                    labels = c("Forest" = "Forest\n(Paracou, Bafog, Kaw)",
                               "Plot" = "Plot",
                               "Habitat" = "Habitat\n(SF, TF)", 
                               "Species" = "Species\n(n=6)")) +
  scale_x_discrete(labels = scales::label_parse()) +
  ggtitle("Portion of total variance (%)")

v2
ggsave(filename = "Variance_partitioning_v2_with_plots.png", plot = v2, bg = "white", width = 10, height = 8, dpi = 600)
```

##v3

 m.gmin<-lmer(log(Gmin)~1+(1|Habitat/Name) + (1|Forest/Plot), data = sub_data_G, na.action = na.omit)
boundary (singular) fit: see help('isSingular') 

*i tried that but i don't have that many sites or plots per sites.*

# Workshop modele complet


H0 : "pas d'effet ni de l'espèce ni du TWI


$$ M0 : Y_{ik} = \mu + E_{ik}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) $$

Le modèle complet:

$$ M_comp : Y_{ijk} = \alpha TWI_{k} + \beta_{j} + A_{is} + E_{ijsk}, \quad E_{ik}\sim \mathcal{N} (0,\sigma^2) , A_{is} \sim \mathcal{N} (0, \sigma^2_{s}) $$

```{r}

M_comp_gmin <- lmer(Gmin ~ TWI + Forest + (1|Name), data=Metradica_log) 
summary(M_comp_gmin)

M_comp_K <- lmer(K ~ TWI + Forest + (1|Name), data=Metradica_log) 


#recupere les valeurs des effet random dans le fit 
## S3 method for class 'merMod'
Ranef_sp <- as.data.frame(ranef(M_comp_gmin)) %>% rename(Name = grp)
Ranef_sp_K <- as.data.frame(ranef(M_comp_K)) %>% rename(Name = grp)


A <- Metradica_log %>% dplyr::select(Name, Type) %>% unique()

Ranef_sp_type<- left_join(Ranef_sp, A, by="Name")
Ranef_sp_type_K<- left_join(Ranef_sp_K, A, by="Name")


library(ggplot2)

#boxplot par habtiat pref 
ggplot(Ranef_sp_type) +
 aes(x = Type, y = condval, fill = Type) +
 geom_boxplot() +
 scale_fill_manual(values = c(BF = "#6DB6F8", 
Generalist = "#00C19F", TF = "#FF61C3")) +
 theme_minimal() #resultat du filtrage env't, les especes de BF ont plus de K dans les feuilles que les 


#sachant l'env't egal, on regarde l'effet espece. 

#partitionniement de variance
M_0_gmin <- lm(Gmin ~1, data= Metradica_log)
M_comp_gmin <- lmer(Gmin ~ TWI + Forest + (1|Name), data=Metradica_log) 
M_comp_gmin_sp <- lmer(Gmin ~ (1|Name), data=Metradica_log) 
M_comp_gmin_envt <- lm(Gmin ~ TWI + Forest, data =Metradica_log )

v_o <- var(residuals(M_0_gmin))
v_comp <- var(residuals(M_comp_gmin))
v_sp <- var(residuals(M_comp_gmin_sp))
v_envt <- var(residuals(M_comp_gmin_envt))

print(c(v_o, v_sp, v_envt, v_comp))

```

Variance partitioning for all individuals 

```{r Function for variance partitioning}
#libray used
library(lme4)

#data used (log on all traits)
Data <- read.csv("Dataset/OUTPUT_cleaning/Subset_imputed/Subset_imputation_exceptSD.csv") %>% 
  rename(Potassium = K, 
         Phosphorous = P, 
         Nitrogen = N,
         Carbon = C) %>% 
  relocate(SD, .after = MajVLA) %>%
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD", "Phosphorous","Carbon", "Nitrogen", "Potassium", "TWI"), abs) %>% 
  mutate_at(c("Gmin","TLP", "LSWC", "MajVLA", "SD", "Phosphorous","Carbon", "Nitrogen", "Potassium", "TWI"), log) %>% 
  mutate(TLP = -TLP) 

#function for variance partitioning
Var_par <- function(Trait, Mydata){

#Rename the trait column
colnames(Mydata)[which(colnames(Mydata) == Trait)] <- "Trait"  


# Fit the linear mixed-effects model
model <- lmer(Trait ~ TWI + Forest + (1 | Name), data = Mydata)

#Fit the associated null model with random intercept on species
null_model <- lmer(Trait~ (1 | Name), data = Mydata)

# Extract the variance components 
var_sp <-  varcomp(model)[1,1] #for the random effects - species
var_indv <- varcomp(model)[2,1] #model residual, also known as the intraspecific residual variance (linked to the individual but also error measures)

# Obtain the variance of the random effect in the null model.
random_variance_null <- varcomp(null_model)$vcov[1]

# Obtain the residual variance
residual_variance_null <- varcomp(null_model)$vcov[2]

# Obtain the total variance of the null model
v_0 <- random_variance_null + residual_variance_null

# Calculate the variance component linked to the env't by substracting the residual variance of the model (var_indv) and the variance explained by the random factor, the species (var_sp), from the variance of the null model
var_envt <- v_0 - var_indv - var_sp

Traits <- c(Trait, Trait, Trait)
Levels <- c("Environment", "Species", "Individual")
Variances <- c(var_envt/v_0, var_sp/v_0, var_indv/v_0)


return(data.frame(Traits, Levels, Variances))
}

# Loop to calculate the variance partitioning for all traits
vars <- c()

for (i in colnames(Data)[14:17]){
  
vars <- bind_rows(vars, Var_par(Trait = i, Mydata = Data))
  
}

#plot the results

variance_plot<- vars %>%  
  mutate(Traits = dplyr::recode(Traits, "Gmin" = "g[min]")) %>% #recode gmin
  ggplot(aes(fill=Levels, y=Variances, x=Traits)) + 
  geom_bar(position="stack", stat="identity") +
  theme_minimal(base_size = 22) +
  ylab("") + xlab("")+
  theme(legend.text = element_text(face = "italic"),legend.position = "bottom") +
    scale_fill_manual("", values = c("#029A88", "#CCBC44", "#BBBBBB"), 
                    labels = c("Environment", 
                               "Species", 
                               "Individual")) +
  scale_x_discrete(labels = scales::label_parse())

variance_plot

#save plot
ggsave(filename = "Variance_partitioning.png", plot = variance_plot, bg = "white", width = 10, height = 8, dpi = 600)

c <- Var_par(Trait = "Carbon", Mydata= Data)

```

When examining the output of a VP, you may notice that the total of the variance explained by each partition and the total residual variance will exceed "1" or "100%". Negative explained variances are also possible. These are artifacts of the VP procedure which arise when certain relationships are present in the data. No solution is available to remove them meaningfully. from https://sites.google.com/site/mb3gustame/constrained-analyses/variation-partitioning

```{r plot residuals}
#function for plotting residuals distribution 
res_plot <- function(Trait, Mydata){

#Rename the trait column
colnames(Mydata)[which(colnames(Mydata) == Trait)] <- "Trait"  


# Fit the linear mixed-effects model
model <- lmer(Trait ~ TWI + Forest + (1 | Name), data = Mydata)
plot <- qqnorm(resid(model), main= Trait)


return(plot)
}

# Loop to calculate the variance partitioning for all traits

plotlist <- list()

for (i in colnames(Data)[9:17]){

  
 plotlist[[i]] <- local({
   
    i <- i
  
   res_plot(i, Data)
  })
  
  
}

    
```







